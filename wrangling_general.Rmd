---
title: "Climate Water Loss Experiment - General Data Wrangling"
author: "Savannah Weaver"
date: "2021"
output: pdf_document
toc: TRUE
---


# Packages

```{r setup, include = TRUE, message = FALSE}
if (!require("tidyverse")) install.packages("tidyverse")
library("tidyverse") # workflow and plots
if (!require("zoo")) install.packages("zoo")
library("zoo") # interpolation using na.approx (weather data)
if (!require("weathermetrics")) install.packages("weathermetrics")
library("weathermetrics") # F to C conversion (weather data)
```


# Background and Goals

This data was collected June - August by Master's student Savannah Weaver, advisor Dr. Emily Taylor, and research assistants Tess McIntyre and Taylor Van Rossum. Adult male *Sceloporus occidentalis* were caught across the Cal Poly campus and in Poly Canyon. This R file compiles and formats the measurements taken. Please refer to the published scientific journal article for full details.


# Load Data

## Variable Summary

- measurement_date = date measurements were taken, including capture day
- collection/capture time for each lizard
- time_processed = when mass and blood draw were recorded
- time_c_temp = the time when cloacal temperature was recorded, immediately after CEWL measurements
- type = whether measurements were during experiment (exp) or after rehydration (post-rehab). For this R script/analysis, I'm only going to use capture day data, which is listed as "exp"
- day = whether measurements are from capture day or post-experiment, which was recorded in relation to CEWL & cloacal temp data. All observations used for this analysis will be from capture day
- individual ID for each lizard
- mass in grams
- hemolyzed = whether or not red blood cells burst and contaminated plasma
- hematocrit_percent = percent of blood that's red blood cells (measured in CRITOCAP microhematocrit capillary tubes)
- osmolality_mmol_kg_mean = the mean of 1-3 technical replicates of plasma osmolality measurements taken from plasma extracted from our blood samples and run on a VAPRO vapor pressure osmometer
- CEWL_g_m2h_mean = the mean of 3-5 technical replicates, after outliers were omitted, of CEWL measurements taken in the same area of the dorsum
- cloacal_temp_C = cloacal temperature recorded immediately after CEWL measurements
- capture_date = date of capture. For this dataset, it should be the same as measurement date
- day_n = numeric day of measurement. In this dataset, it should always be zero
- capture_date_time = combination of capture date and time
- SVL_mm = snout-to-vent length in mm



## Lizard Data

```{r load lizard data}
lizard_dat <- read.csv("./data/mass_hct_notes.csv", # filename
                             na.strings=c("","NA") # fix empty cells
                             ) %>%
  # join with experiment treatment assignment data
  left_join(read.csv("./data/tmt_assignments.csv"),
            by = "individual_ID") %>%
          # fix date format
  mutate(measurement_date = as.Date(measurement_date, 
                                          format = "%m/%d/%y"),
          # set categorical variables as factors
         individual_ID = as.factor(individual_ID),
         type = as.factor(type),
         blood_sample_eye = as.factor(blood_sample_eye),
         hemolyzed = as.factor(hemolyzed),
         trial_number = as.factor(trial_number),
         temp_tmt = as.factor(temp_tmt),
         humidity_tmt = as.factor(humidity_tmt),
         tmt = as.factor(paste(temp_tmt, humidity_tmt)),
         conclusion = as.factor(conclusion)
         ) %>%
  group_by(individual_ID) %>%
          # for each individual, extract capture date
  mutate(capture_date = min(measurement_date),
         # create "day of experiment" variable, both numeric and factor
         day_n = as.numeric(measurement_date - capture_date),
         day_factor = as.factor(day_n))
summary(lizard_dat)
```


## Join Osml & CEWL Data

```{r osml & CEWL data}
full_dat <- lizard_dat %>%
  # osmolality data
  left_join(read_rds("./data/osml_means_clean.RDS"), 
            by = c("individual_ID", "measurement_date" = "date_blood_drawn")
            ) %>%
  # join CEWL data
  left_join(read_rds("./data/CEWL_dat_all_clean.RDS"), 
            by = c("individual_ID", "measurement_date" = "date")
            ) %>%
  # remove some unnecessary variables
              # too few left eye or hemolyzed blood samples to matter statistically
  dplyr::select(-blood_sample_eye, -hemolyzed, 
                # notes no longer necessary/useful
                -notes.x, -notes.y, -shed, -tail_broken, -died,
                -time_c_temp, -day
                ) %>%
          # compute vapor pressure deficit
  mutate(msmt_temp_K = msmt_temp_C + 273.15,
         # find saturation level first
         e_s_kPa_m = 0.611*exp((2500000/461.5)*
                                  ((1/273)-(1/msmt_temp_K))),
         # actual vapor pressure
         e_a_kPa_m = e_s_kPa_m * (msmt_RH_percent/100),
         # VPD
         msmt_VPD_kPa = e_s_kPa_m - e_a_kPa_m
         ) %>%
  # remove data for one lizard that was an accidental recapture
  dplyr::filter(individual_ID != 304)

summary(full_dat)
# check
unique(full_dat$capture_date)
```



                 


# Compute Scaled Mass Index

This is also known as the body condition index, or log-log residuals.

I calculate as described by: Peig, J., & Green, A. J. (2009). New perspectives for estimating body condition from mass/length data: The scaled mass index as an alternative method. Oikos, 118(12), 1883â€“1891. https://doi.org/10.1111/j.1600-0706.2009.17643.x

### Step 1: Simple Linear Regression

I only use capture mass measurements for these calculations because that's what's representative of body condition naturally.

```{r SMI SLR}
SLR_dat <- full_dat %>% dplyr::filter(day_n == 0)
mass_SVL_SLR <- lm(data = SLR_dat, mass_g ~ SVL_mm)
summary(mass_SVL_SLR)
```


### Step 2: Identify Outliers

```{r SMI equation outliers 1}
plot(mass_SVL_SLR)
```

The conditions of linearity, equal error variance, and normality are all satisfied. It doesn't look like any residuals are >3 or <-3.

```{r SMI equation outliers 2}
boxplot(residuals(mass_SVL_SLR))
hist(residuals(mass_SVL_SLR))
```

From the boxplot, there is one individual with a much higher residual than the rest of the distribution. The histogram looks beautiful and incredibly normally distributed.

Check average residual value:

```{r SMI equation outliers 3}
mean(residuals(mass_SVL_SLR))
median(residuals(mass_SVL_SLR))
```

The mean is basically zero and the median is pretty close to zero, which is very good.

Check for high leverage points:

```{r SMI equation outliers 4}
# compute values for observations 
high_leverage <- data.frame(H = hatvalues(mass_SVL_SLR)) %>% 
  mutate(row = row_number())

# compute cutoff value 
h_bar <- (3*sum(high_leverage$H))/nrow(high_leverage)

# add to original dataframe 
# see which observations have extremely high leverage (if any)
high_leverage_dat <- SLR_dat %>%
  mutate(row = row_number()) %>%
  left_join(., high_leverage, by = "row") %>%
  dplyr::filter(H > h_bar) 
high_leverage_dat
```

No points are considered high leverage, which is fantastic.

Check for influential points based on Cook's distance:

```{r SMI equation outliers 5}
# get Cook's distance 
cooks <- data.frame(c = cooks.distance(mass_SVL_SLR)) %>% 
  mutate(row = row_number())

# add to original dataframe 
influential <- SLR_dat %>%
  mutate(row = row_number()) %>% 
  left_join(., cooks, by = "row")

# see moderately influential points 
cook_mod_inf <- influential %>% 
  dplyr::filter(c>0.5) 
cook_mod_inf
```

There are no infuential points based on Cook's distance, so there's nothing to potentially remove.

We could remove the one outlier found using the boxplot, but it's the only one, so we will leave it in the dataset. No points were indicated to be outliers based on residuals or a histogram, and there were no high leverage or influential points. Thus I can create a log-log model using the data as-is. Observation omissions are unlikely to increase generalizability.


 
### Step 3: log-log Regression

```{r SMI log log regression}
log_mass_SVL_SLR <- lm(data = SLR_dat, log(mass_g) ~ log(SVL_mm))
summary(log_mass_SVL_SLR)
```


### Step 4: Extract Values

compute standardized major axis using the log-log regression equation:

```{r SMI equation}
r <- sqrt(0.5714) # Pearson's correlection coefficient (sqrt of R-squared)
b_OLS <- 1.9743 # regression slope
b_SMA <- b_OLS/r
```

mean length in capture data:

```{r mean SVL}
L0 <- mean(SLR_dat$SVL_mm)
```


### Step 5: Calculate Scaled Mass Index

Add SMI to an updated full_dat df - full_dat2

```{r join all data}
full_dat2 <- full_dat %>%
  # compute SMI
  mutate(SMI = mass_g * ((L0/SVL_mm) ^ b_SMA))
ggplot(full_dat2) + 
  geom_point(aes(x = mass_g,
                 y = SMI))
```





# Capture Data

## Split from Full

Extract only the data from capture day (1 row of observations for each individual) for some initial/baseline physiology analyses. The experiment analyses will use the full dataframe.

```{r format cap data}
capture_dat <- full_dat2 %>%
          # select only data from capture days
  dplyr::filter(day_n == 0) %>%
  # make sure only complete data included
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean,
                               CEWL_g_m2h_mean, cloacal_temp_C)) %>%
  # make capture_date_time variable
  mutate(capture_date_time = as.POSIXct(paste(capture_date, time_captured, 
                                              sep = " "),
                              format = "%Y-%m-%d %H:%M"),
         hold_time_sec = (date_time - capture_date_time),
         hold_time_min = (hold_time_sec)/60,
         hold_time_hr = (hold_time_min)/60
         ) %>%
  # remove experiment variables not relevant to capture analysis
  dplyr::select(-type, -trial_number, -temp_tmt, -humidity_tmt, -tmt,
                -conclusion, -day_n, -day_factor, 
                # redundant variables
                -time_captured, -time_processed,
                -measurement_date)
summary(capture_dat)
```

Also do some capture-based summary stats for permit reporting:

```{r}
permit_stats <- capture_dat %>%
  group_by(capture_date) %>%
  summarise(n = n()) %>%
  mutate(sex = "M")
permit_stats
sum(permit_stats$n)
write.csv(permit_stats, "./data/collection_summary.csv")
```






## Get & Join Weather

This data was obtained from http://www.itrc.org/databases/precip/ (Adcon Server Data) to test the effect of ambient conditions on CEWL.

Load and format: 

```{r load weather data}
weather <- read.csv("./data/weather.csv", sep = ';') %>%
         # add a variable for combined date-time
  mutate(capture_date_time = as.POSIXct(paste(date, time),
                                format = "%m/%d/%y %I:%M %p"))
```

The weather data is only every 15 minutes, but I want to match it to any minute measurement, so I need to interpolate the values for each minute.

First, make a separate dataframe with every minute on each capture day.

```{r every minute data}
all_times <- data.frame(capture_date_time = c(
                           # June 16
                           seq(from = as.POSIXct("2021-06-16 07:00"),
                               to = as.POSIXct("2021-06-16 19:00"),
                               by="min"),
                           # June 26
                           seq(from = as.POSIXct("2021-06-26 07:00"),
                               to = as.POSIXct("2021-06-26 19:00"),
                               by="min"),
                           # July 20
                           seq(from = as.POSIXct("2021-07-20 07:00"),
                               to = as.POSIXct("2021-07-20 19:00"),
                               by="min"),
                           # August 8
                           seq(from = as.POSIXct("2021-08-08 07:00"),
                               to = as.POSIXct("2021-08-08 19:00"),
                               by="min"),
                           # August 22
                           seq(from = as.POSIXct("2021-08-22 07:00"),
                               to = as.POSIXct("2021-08-22 19:00"),
                               by="min")
                           ))

```

Next, merge the weather data into the times dataframe and interpolate the temperature and humidity between measurements.

```{r merge weather data}
weather_every_minute <- all_times %>% # time only dataframe
  # add weather measurements based on matching date-time
  left_join(weather, by = 'capture_date_time') %>%
         # convert temperature units F->C
  mutate(temp_C = fahrenheit.to.celsius(temperature_F, round = 2),
         # interpolate temperatures
         temp_C_interpol = na.approx(temp_C),
         # also get temperature C-> K
         temp_K_interpol = temp_C_interpol + 273.15,
         # interpolate humidities
         RH_percent_interpol = na.approx(relative_humidity_percent),
         # interpolate Wind Speeds
         wind_mph_interpol = na.approx(wind_speed_mph),
         # interpolate solar radiation
         solar_rad_W_sqm_interpol = na.approx(solar_radiation_W_sqm),
         # compute vapor pressure deficit
         # find saturation level first
         e_s_kPa_int = 0.611*exp((2500000/461.5)*
                                  ((1/273)-(1/temp_K_interpol))),
         # actual vapor pressure
         e_a_kPa_int = e_s_kPa_int * (RH_percent_interpol/100),
         # VPD
         VPD_kPa_int = e_s_kPa_int - e_a_kPa_int
         ) %>%
  # keep only the relevant variables
  dplyr::select(capture_date_time, 
                temp_C_interpol, 
                RH_percent_interpol, 
                VPD_kPa_int,
                wind_mph_interpol, 
                solar_rad_W_sqm_interpol)
summary(weather_every_minute)
```

add the weather data in:

```{r}
capture_dat2 <- capture_dat %>%
  left_join(weather_every_minute, by = 'capture_date_time')
```





## Export

```{r}
write_rds(capture_dat2, "./data/analysis_data_capture.RDS")
```



# Full Data

## Format 

Remove data for individuals with canceled experimental treatments:

```{r}
full_dat3 <- full_dat2 %>%
  dplyr::filter(conclusion == "complete") %>%
  dplyr::select(-time_captured, -time_processed, 
                -capture_date, -date_time, 
                -conclusion)
```


Rename some factors:

```{r rename factors}
full_dat3$humidity_tmt <- factor(full_dat3$humidity_tmt,
                           levels = c("humid", "dry"),
                           labels = c("Humid", "Dry"))
full_dat3$temp_tmt <- factor(full_dat3$temp_tmt,
                           levels = c("hot", "cool"),
                           labels = c("Hot", "Cool"))
full_dat3$tmt <- factor(full_dat3$tmt,
                           levels = c("cool humid",
                                      "hot humid", 
                                      "cool dry", 
                                      "hot dry"),
                           labels = c("Cool Humid (0.6 kPa)", 
                                      "Hot Humid (1.1 kPa)", 
                                      "Cool Dry (2.5 kPa)", 
                                      "Hot Dry (3.8 kPa)"))

summary(full_dat3)
```

## Export

```{r export full dat}
write_rds(full_dat3, "./data/analysis_data_experiment.RDS")
```













