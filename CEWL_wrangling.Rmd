---
title: "Climate Water Loss Experiment - CEWL Data Wrangling"
author: "Savannah Weaver"
date: "2021"
output: pdf_document
toc: TRUE
---


# Packages


```{r setup, include=FALSE}
`%nin%` = Negate(`%in%`)
if (!require("tidyverse")) install.packages("tidyverse")
library("tidyverse") # workflow and plots
if (!require("UsingR")) install.packages("UsingR")
library("UsingR")
if (!require("lme4")) install.packages("lme4")
library("lme4") # for LMMs
if (!require("lmerTest")) install.packages("lmerTest")
library("lmerTest") # for p-values
```


# Background and Goals

This CEWL (cutaneous evaporative water loss) data was collected June - August using a handheld evaporimeter (BioX AquFlux) on adult male *Sceloporus occidentalis*. Measurements were taken on the dorsum in 5 technical replicates before and after 8 days in different climate treatments. In this R script, I bring all the data files into one dataframe, check the distribution of replicates, omit outliers, and average remaining replicates. The final values will be more precise and accurate estimates of the true CEWL, and those values will be used in the capture_analysis and experiment_analysis R script files. Please refer to **doi:** for the published scientific journal article and full details.


# Load Data

1. Compile a list of the filenames I need to read-in.

```{r}
# make a list of file names of all data to load in
filenames <- list.files(path = "data/CEWL", pattern = "\\.csv$")
```

2. Make a function that will read in the data from each csv, name and organize the data correctly. 

```{r}
read_CEWL_file <- function(filename) {
  
  dat <- read.csv(file.path("data/CEWL", filename),
                # each csv has headers
                header = TRUE
                # this is what I want to rename the col headers
                #col.names = c("seq_no", "date", "time", "ID_rep_no",
                 #             "status", "termination", "CEWL_g_m2h",
                  #            "CV", "SSWL", "msmt_temp_C", "msmt_RH_percent",
                   #           "dont_need_rest")
                ) %>%
    # select only the relevant values
    dplyr::select(date = Date, 
                  time = Time, 
                  status = Status,
                  ID_rep_no = Comments,
                  CEWL_g_m2h = 'TEWL..g..m2h..', 
                  msmt_temp_C = 'AmbT..C.', 
                  msmt_RH_percent = 'AmbRH....'
                  ) %>%
    # extract individual_ID and replicate number
    dplyr::mutate(ID_rep_no = as.character(ID_rep_no),
                  individual_ID = as.numeric(substr(ID_rep_no, 1, 3)),
                  replicate_no = as.numeric(substr(ID_rep_no, 5, 5))
                  )
  
  # return the dataframe for that single csv file
  dat
}
```

3. Apply the function I made to all of the filenames I compiled, then put all of those dataframes into one dataframe. This will print warnings saying that header and col.names are different lengths, because the data has extra notes cols that we read-in, but get rid of.

4. Filter out failed measurements and properly format data classes.

```{r}
# apply function to get data from all csvs
all_CEWL_data <- lapply(filenames, read_CEWL_file) %>%
  # paste all data files together into one df by row
  reduce(rbind) %>%
  dplyr::filter(status == "Normal") %>%
  mutate(date_time = as.POSIXct(paste(date, time), 
                                format = "%m/%d/%y %I:%M:%S %p"),
         date = as.Date(date, 
                        format = "%m/%d/%y"),
         time = as.POSIXct(time, 
                           format = "%I:%M:%S %p"),
         status = as.factor(status),
         individual_ID = as.factor(individual_ID),
         replicate_no = as.factor(replicate_no)
         )
summary(all_CEWL_data)
```

5. Load in and format the cloacal temperature measured at the time of CEWL measurement.

```{r}
cloacal_temp_C <- read.csv("./data/c_temps.csv", # filename
                             na.strings=c("","NA") # fix empty cells
                             ) %>%
  dplyr::select(date, time_c_temp, 
                day, 
                individual_ID, 
                cloacal_temp_C) %>%
  mutate(date_time = as.POSIXct(paste(date, time_c_temp), 
                                format = "%m/%d/%y %H:%M"),
         date = as.Date(date, format = "%m/%d/%y"),
         time_c_temp = (as.POSIXct(time_c_temp, format = "%H:%M")),
         day = as.factor(day),
         individual_ID = as.factor(individual_ID),
         cloacal_temp_C = as.numeric(cloacal_temp_C)
         ) %>%
  dplyr::filter(complete.cases(.))
summary(cloacal_temp_C)
```

6. Load in and format the tmt assignments so we know which lizards were removed from the experiment.

```{r}
tmt <- read.csv("./data/tmt_assignments.csv") %>%
  mutate(trial_number = as.factor(trial_number),
         temp_tmt = as.factor(temp_tmt),
         humidity_tmt = as.factor(humidity_tmt),
         individual_ID = as.factor(individual_ID),
         conclusion = as.factor(conclusion)
         )
summary(tmt)

# specifically save canceled ones
canceled <- tmt %>%
  dplyr::filter(conclusion == "canceled") %>%
  dplyr::select(individual_ID)
canceled
```




# Check Data

## Dates

We should only have measurements from day 0 (beginning of date ranges below) and day 8 (end of date ranges below) for each trial.

Trail 1: June 16-24
Trail 2: June 26 - July 4
Trial 3: July 20-28
Trial 4: August 8-16
Trial 5: August 22-30

```{r}
all_CEWL_data %>%
  group_by(date) %>%
  summarise(count = n())
```

All the correct dates, and only the correct dates, are in our dataset. In every trial except trial 5, the number of observations decreases post-experiment compared to pre-experiment, either due to lost lizards or the few that died during the experiment.


## Number of Measurements

Each individual should have 10 total measurements (5 before the experiment, 5 after). 

```{r}
rep_check <- all_CEWL_data %>%
                group_by(individual_ID) %>%
                summarise(n = n()) %>% 
                arrange(n)
rep_check
```

Oof... Many individuals have more or less than 10 CEWL measurements.

**too many: 206 & 215 = 11; 237 & 302 = 15**
too few: 254 = 3; 213, 216, 245, 278, 289, 294, 305 = 9

There are also a handful with 5 measurements... Check whether these are the ones that had their treatment canceled (thus would only have measurements from pre experiment, not post).

```{r}
rep_check %>% dplyr::filter(n == 5) 
canceled
```


*212*, *233*, 239, *248*, *283*, *284*, and 303 were the individuals with only 5 CEWL values. Of these, five individuals (italicized IDs) had their treatment canceled, so we have an explanation for their missing data.

Individuals 254 and 304 had their treatment canceled. 254 only had 3 measurements taken because they were lost during CEWL measurement pre-treatment. *Individual 304 seems to have the correct number of observations, which will need to be validated...*

Individuals 239 and 303 only have 5 CEWL measurements, and it was unable to be explained by treatment cancellation.

After these quick checks, these individuals still have **too few: 213, 216, 245, 278, 289, 294, 305 ** (all 9 observations)

```{r}
indiv_too_few <- c(213, 216, 245, 278, 289, 294, 305)
indiv_too_many <- c(206, 215, 237, 302)
```





***Left off here***




Next, check how many measurements each individual has under each replicate number for each date to see if there are duplicates.

```{r}
rep_check_1 <- all_CEWL_data %>%
                group_by(individual_ID, date) %>%
                summarise(n = n()) %>% 
                arrange(n)
rep_check_1
unique(rep_check_1$n)
```

Individuals 206, 215, 237, and 302 have too many measurements. Others only have 3-4.

## Extra Measurements

```{r}
rep_check_2 <- all_CEWL_data %>%
                group_by(individual_ID, date, replicate_no) %>%
                summarise(n = n()) %>% 
                arrange(n)
rep_check_2
unique(rep_check_2$n)
```

Individual 206 has two values named replicate 2.
Individual 215 has two values named replicate 1.
Individual 233 has two values named replicate 5.
Individuals 237 and 302 each have two values for each of the five replicates named 1-5...


## Missing Measurements

Which individuals are missing replicates?

```{r}
individuals_missing_reps <- rep_check_1 %>%
  dplyr::filter(n < 5)
individuals_missing_reps
```

Maybe 215 stole one of the 216 measurements?

Specifically check how many replicates individuals on either side of the jumbo-replicates had.

```{r}
IDs_to_check <- c(205, 207, 214, 216, 232, 234, 236, 238, 301, 303)
at_risk_missing_reps <- rep_check_1 %>%
  dplyr::filter(individual_ID %in% IDs_to_check) %>%
  arrange(individual_ID)
at_risk_missing_reps
```

Individual 216 is missing a measurement on June 24 and individual 303 is missing all their measurements on August 8.

Individuals 205, 207, 214, 232, 234, 236, 238, and 301 have all expected measurements.

Also check whether any other individuals are missing all measurements for a given date:

```{r}
rep_check_1 %>% # should have 2 occurrences per individual ID
  group_by(individual_ID) %>%
  summarise(n = n()) %>%
  dplyr::filter(n == 1)
```

8 Individuals are missing data for one date. 
Individuals 212, 233, 248, 254, 283, and 284 died during or were removed from the experiment, so it would make sense to only have one date of CEWL measurements (capture day, pre-experiment). I will leave these in the dataset because I can still use them for 'capture_analysis'.

Individuals 239 and 303 should have measurements for 2 dates, so there's potential that their measurements were "stolen".


## Associations

View the measurements in question:

```{r}
rep_check_3 <- all_CEWL_data %>%
  dplyr::filter(individual_ID %in% c(216, 239, 303 # adjacent missing ones
                                     #215, 302 # adjacent extra ones
                                     #206, 233, 237 # other extra ones
                                     ) 
                ) %>%
  arrange(individual_ID, date, time)
rep_check_3
```

*The duplicates for Individual 206 seem fine. I'll rename one "6".*

The extra value for Individual 233 is a completely different time, so I'm going to omit that value. 

Individual 237 has two rounds of measurements on July 4, I'll need to figure out which group of values to use because they're so different.

The extra value for Individual 215 on June 24 was taken ~40 minutes later than the rest of the measurements, at 11:53:32 AM, so definitely possible that the individual ID was a typo.

The two groups of values taken for Individual 302 on August 8 are clearly in two groupings, so one group is probably for a different Individual.

*Individual 216 I think only had 4 measurements. Emily must have skipped "4".* The time doesn't match up with the extra value for Individual 215, so *the extra value for Individual 215 should be omitted*.

*Individual 239 is missing their post-experiment measurements from July 4, which is probably one of the groups labeled as Individual 237.* 

*Individual 303 is missing their pre-experiment measurements from August 8, which is probably one of the groups labeled as Individual 302.*

To figure out which groups of CEWL measurements were assigned incorrectly, I can use the time noted at cloacal temperature measurement:

```{r}
cloacal_temp_C %>%
  dplyr::filter(individual_ID %in% c(239, 237, 303, 302))
all_CEWL_data %>%
  dplyr::filter(individual_ID %in% c(239, 237, 303, 302))
```

Cloacal temperature measurement times:
I239, July 4: 10:33
I237, July 4: 12:24
I303, Aug 8: 12:49 PM
I302, Aug 8: 12:55 PM

So, assigned groups of times of CEWL measurements:
I239, July 4: 10:26 - 10:33
I237, July 4: 12:21 - 12:25

The times don't match up for these ones weirdly, but based on interrelation:
I303, Aug 8: 1:01 - 1:06 PM
I302, Aug 8: 1:09 - 1:13 PM


## Properly Re-Assigning Measurements

Measurements for individuals currently labeled 206, 215, 237, and 302 need to have editing done.

1. Reassign one of the 206 replicates as "replicate 6":

```{r}
all_CEWL_data[228, "replicate_no"] <- 6
```

2. Reassign some 237 values to 239:

```{r}
all_CEWL_data[801:805, "individual_ID"]
all_CEWL_data[801:805, "individual_ID"] <- 239
all_CEWL_data[801:805, "individual_ID"]
```

3. Reassign some 302 values to 303:

```{r}
all_CEWL_data[1074:1078, "individual_ID"]
all_CEWL_data[1074:1078, "individual_ID"] <- 303
all_CEWL_data[1074:1078, "individual_ID"]
```

4. In looking at the dataframe, I realized the weird 215 value is actually a mis-labeled value for individual 213, so reassign that:

```{r}
all_CEWL_data[241, "individual_ID"] <- 213
all_CEWL_data[241, "replicate_no"] <- 5
```



# Format Data

```{r}
clean_CEWL <- all_CEWL_data %>%
  mutate(date = as.Date(date, format = "%m/%d/%y"),
         time = as.POSIXct(time, format = "%H:%M"),
         status = as.factor(status),
         individual_ID = as.factor(individual_ID),
         replicate_no = as.factor(replicate_no)
  )
summary(clean_CEWL)
```


# Re-Check Data

## Number of Measurements

Re-check how many measurements each individual has:

```{r}

```


## Measurement Times

Also check that all the measurement times for a given individual on a certain date are within ~10 minutes:

```{r}

```






# Replicates

## Check Distribution
## Technical Replicates COV

```{r}
COVs <- all_CEWL_data %>%
  group_by(individual_ID, date) %>%
  summarise(CEWL_mean = mean(CEWL_g_m2h),
            CEWL_SD = sd(CEWL_g_m2h),
            COV = (CEWL_SD/CEWL_mean) *100
            )
summary(COVs)
sd(COVs$CEWL_mean)
sd(COVs$COV)
```


## Remove Outliers

## Re-Check Distribution


## Average Replicates (outliers now removed) & Join Cloacal Temp Data

```{r}
CEWL_final <- CEWL_clean %>%
  group_by(date, individual_ID) %>%
  summarise(CEWL_g_m2h = mean(CEWL_g_m2h)) %>%
  left_join(cloacal_temp_C, by = c('date', 'individual_ID'))
```


# Export

```{r}
write.csv(CEWL_final, "./data/CEWL_dat_all_clean.csv")
```



*other stuff*
after finishing CEWL, go straight to avg osml
do very simple invert analysis of just water content over time
















