---
title: "Climate Water Loss Experiment - Treatment Hydration Analysis"
author: "Savannah Weaver"
date: "2021"
output: pdf_document
toc: TRUE
---

# Packages

```{r setup, include = TRUE, message = FALSE}
`%nin%` = Negate(`%in%`)
if (!require("tidyverse")) install.packages("tidyverse")
library("tidyverse") # workflow and plots
if (!require("lme4")) install.packages("lme4")
library("lme4") # for LMMs
if (!require("lmerTest")) install.packages("lmerTest")
library("lmerTest") # for p-values
if (!require("ggpubr")) install.packages("ggpubr")
library("ggpubr") # for multi-ggplot figs
if (!require("UsingR")) install.packages("UsingR")
library("UsingR") # simple.eda model assumption checker
if (!require("broom")) install.packages("broom")
library("broom") # lmer model export
if (!require("broom.mixed")) install.packages("broom.mixed")
library("broom.mixed") # lmer model export
```


# Background and Goals

This data was collected June - August by Master's student Savannah Weaver, advisor Dr. Emily Taylor, and research assistants Tess McIntyre and Taylor Van Rossum. Adult male *Sceloporus occidentalis* were caught across the Cal Poly campus and in Poly Canyon. This R file analyzes the effect of experimental climate treatments on their body condition, osmotic balance, and osmoregulation. Please refer to **doi:** for the published scientific journal article and full details.


# Data

## Load

Read-in data that was compiled, formatted, and checked for completeness in 'capture_analysis'. See that file for information related to the variables. Some variables need to be re-formatted because they lose their data class in export/import. Attach treatment assignments and format that data. Also compute scaled mass index using the equation derived in 'capture_analysis'.

```{r load data}
dat <- read.csv("./data/full_exp_data.csv", # main dataset
                na.strings=c("","NA")) %>%
         # reformat individual_ID to make joining easy
  mutate(individual_ID = as.numeric(individual_ID)) %>%
            # join tmt assignment info
  left_join(read.csv("./data/tmt_assignments.csv"),
            by = "individual_ID") %>%
                # remove irrelevant variables
  dplyr::select(-X, -capture_date, 
                -time_captured, -time_processed, -time_c_temp) %>%
          # format date
  mutate(measurement_date = as.Date(measurement_date,
                                    format = "%Y-%m-%d"),
         # set factor classes
         type = as.factor(type),
         day = as.factor(day),
         individual_ID = as.factor(individual_ID), 
         hemolyzed = as.factor(hemolyzed),
         trial_number = as.factor(trial_number),
         tmt = as.factor(paste(temp_tmt, humidity_tmt)),
         temp_tmt = as.factor(temp_tmt),
         humidity_tmt = as.factor(humidity_tmt),
         conclusion = as.factor(conclusion),
         # set numeric classes
         day_n = as.numeric(day_n),
         mass_g = as.numeric(mass_g),
         hematocrit_percent = as.numeric(hematocrit_percent),
         osmolality_mmol_kg_mean = as.numeric(osmolality_mmol_kg_mean),
         CEWL_g_m2h_mean = as.numeric(CEWL_g_m2h_mean),
         cloacal_temp_C = as.numeric(cloacal_temp_C),
         SVL_mm = as.numeric(SVL_mm),
         # compute scaled mass index
         SMI = mass_g * ((67.71/SVL_mm) ^ 2.65)) %>%
  # only use data from lizards who underwent the full experiment
  # this removes 21 obs for the 7 lizards who didn't complete the exp
  dplyr::filter(conclusion == "complete")
summary(dat)
```



## Clean

There are a handful of points that appear erroneous. 

Individual 239 had post-treatment CEWL >60, which is incredibly unusual for our experiment. He was in the process of shedding when we took this CEWL measurement, so we assume that his process of shedding confounded potential treatment effects, and we should remove that point from our data. We still want to use the other measurements for this individual, so we will just set that CEWL measurement as an NA.

```{r fix erroneous CEWL}
which(dat$CEWL_g_m2h_mean > 60)
dat[332, ]
dat[332, "CEWL_g_m2h_mean"]
dat[332, "CEWL_g_m2h_mean"] <- NA
dat[332, "CEWL_g_m2h_mean"]
dat %>%
  dplyr::filter(complete.cases(CEWL_g_m2h_mean)) %>%
  summarise(max(CEWL_g_m2h_mean))
```


10 trial 1 lizards have unreasonably high osmolality measurements on June 24, which we think are due to an osmometer technical error. The values are way too far outside the usual range to be trustworthy, so we will exclude them.

```{r fix erroneous osml}
which(dat$osmolality_mmol_kg_mean > 500)
dat[136:145, ]
dat[136:145, "osmolality_mmol_kg_mean"]
dat[136:145, "osmolality_mmol_kg_mean"] <- c(rep(NA, 10))
dat[136:145, "osmolality_mmol_kg_mean"]
dat[136:145, ]
dat %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean)) %>%
  summarise(max(osmolality_mmol_kg_mean))
```




## Format

Rename some factors:

```{r rename factors}
dat$humidity_tmt <- factor(dat$humidity_tmt,
                           levels = c("humid", "dry"),
                           labels = c("Humid", "Dry"))
dat$temp_tmt <- factor(dat$temp_tmt,
                           levels = c("hot", "cool"),
                           labels = c("Hot", "Cool"))
dat$tmt <- factor(dat$tmt,
                           levels = c("hot humid", "hot dry",
                                      "cool humid", "cool dry"),
                           labels = c("Hot Humid", "Hot Dry",
                                      "Cool Humid", "Cool Dry"))
summary(dat)
```


Make sub-dataframes without rehab data / with only rehab-related data:

```{r sub-dfs}
dat_no_rehab <- dat %>%
  dplyr::filter(type == "exp")
dat_for_rehab <- dat %>%
  dplyr::filter(day_n %in% c(8, 10))
```



## Check

Dates:

```{r check dates}
unique(dat$measurement_date)
```

Number of measurements for each lizard:

```{r check n msmts}
dat_no_rehab %>%
  group_by(individual_ID) %>%
  summarise(n = n()) %>%
  arrange(n)
```


Every lizard has 6 experimental measurements: pre-tmt, mid-tmt, post-tmt, and mass checks on each of the 3 days between mid and post-tmt.


Did any of the treatment groups inherently start out with large differences in response variables?


```{r check starting diffs}
dat %>%
  dplyr::filter(day == "capture") %>%
  group_by(tmt) %>%
  summarise(mean(mass_g),
            mean(SMI),
            mean(hematocrit_percent),
            mean(osmolality_mmol_kg_mean),
            mean(CEWL_g_m2h_mean))
```

There are slight differences, but overall the starting values across groups are more or less the same.




# Experiment Figures

## SMI

```{r SMI exp fig}
# calculate means to overlay
mean_SMI <- dat %>%
  dplyr::filter(day == "post-exp") %>%
  dplyr::filter(complete.cases(SMI)) %>%
  group_by(tmt) %>%
  summarise(day = 8,
            mean_SMI = mean(SMI))

# plot!!
dat_no_rehab %>% 
  ggplot(aes(x = day_n,
             y = SMI, 
             color = tmt,
             )) + 
  geom_line(aes(group = individual_ID),
            alpha = 0.2) +
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.2, 
              alpha = 1 ) + 
  # this point is more for the legend than for showing means
  geom_point(data = mean_SMI,
             aes(x = day,
                 y = mean_SMI - 0.1, # slight adjustment to center on line
                 color = tmt,
                 shape = tmt),
             size = 4, 
             alpha = 1) +
  theme_classic() + 
  scale_shape_manual(values = c(15:18), name = "") +
  scale_x_continuous(breaks = c(0, 2, 4, 6, 8)) +
  scale_color_brewer(palette = "Set2", name = "") +
  xlab("") + 
  ylab("Body Condition (g)") + 
  guides(shape = guide_legend(nrow = 2, byrow = TRUE)) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 22),
        legend.text.align = 0,
        legend.position = "none"
) -> tmt_effects_SMI
tmt_effects_SMI

# export figure
ggsave(filename = "tmt_effects_SMI.jpeg",
       plot = tmt_effects_SMI,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 4)
```





## Hct

```{r hct exp fig}
# calculate means to overlay
mean_hct <- dat %>%
  dplyr::filter(day == "post-exp") %>%
  dplyr::filter(complete.cases(hematocrit_percent)) %>%
  group_by(tmt) %>%
  summarise(day = 8,
            mean_hct = mean(hematocrit_percent))
# plot
dat_no_rehab %>% 
  dplyr::filter(complete.cases(hematocrit_percent)) %>%
  ggplot(aes(x = day_n,
             y = hematocrit_percent, 
             color = tmt,
             )) +
  geom_line(aes(group = individual_ID),
            alpha = 0.2) +
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.2, 
              alpha = 1 ) + 
  # this point is more for the legend than for showing means
  geom_point(data = mean_hct,
             aes(x = day,
                 y = mean_hct, 
                 color = tmt,
                 shape = tmt),
             size = 4, 
             alpha = 1) +
  theme_classic() + 
  scale_shape_manual(values = c(15:18), name = "") +
  scale_x_continuous(breaks = c(0, 2, 4, 6, 8)) +
  scale_color_brewer(palette = "Set2", name = "") +
  xlab("") + 
  ylab("Hematocrit (%)") + 
  guides(shape = guide_legend(nrow = 2, byrow = TRUE)) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 22),
        legend.text.align = 0,
        legend.position = "none"
        ) -> tmt_effects_hct
tmt_effects_hct

# export figure
ggsave(filename = "tmt_effects_hct.jpeg",
       plot = tmt_effects_hct,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 4)
```





## Osmolality


```{r osmolality exp fig}
# calculate means to overlay
mean_osml <- dat %>%
  dplyr::filter(day == "post-exp") %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean)) %>%
  group_by(tmt) %>%
  summarise(day = 8,
            mean_osml = mean(osmolality_mmol_kg_mean))
# plot
dat_no_rehab %>% 
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean)) %>% 
  ggplot(aes(x = day_n,
             y = osmolality_mmol_kg_mean, 
             color = tmt,
             )) + 
  geom_line(aes(group = individual_ID),
            alpha = 0.2) +
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.2, 
              alpha = 1 ) + 
  # this point is more for the legend than for showing means
  geom_point(data = mean_osml,
             aes(x = day,
                 y = mean_osml + 3, # slight adjust to center on line 
                 color = tmt,
                 shape = tmt),
             size = 4, 
             alpha = 1) +
  theme_classic() + 
  scale_shape_manual(values = c(15:18), name = "") +
  scale_x_continuous(breaks = c(0, 2, 4, 6, 8)) +
  scale_color_brewer(palette = "Set2", name = "") +
  xlab("Day") + 
  ylab("Osmolality (mmol / kg)") + 
  guides(shape = guide_legend(nrow = 2, byrow = TRUE)) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 22),
        legend.text.align = 0,
        legend.position = "bottom"
        ) -> tmt_effects_osml
tmt_effects_osml

# export figure
ggsave(filename = "tmt_effects_osml.jpeg",
       plot = tmt_effects_osml,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 4)
```



## Multi-Figure

```{r arrange exp figs}
ggarrange(tmt_effects_SMI,
          tmt_effects_hct,
          tmt_effects_osml,
          ncol = 1, nrow = 3,
          common.legend = TRUE,
          legend = "bottom"
          ) -> tmt_multi_fig
tmt_multi_fig
# export figure
ggsave(filename = "tmt_multi_fig.jpeg",
       plot = tmt_multi_fig,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 12)
```



## CEWL

```{r CEWL fig}
mean_CEWL <- dat %>%
  dplyr::filter(day == "post-exp") %>%
  dplyr::filter(complete.cases(CEWL_g_m2h_mean)) %>%
  group_by(tmt) %>%
  summarise(day = 8,
            mean_CEWL = mean(CEWL_g_m2h_mean))
dat %>% 
  dplyr::filter(complete.cases(CEWL_g_m2h_mean)) %>%
  ggplot(aes(x = day_n,
             y = CEWL_g_m2h_mean, 
             color = tmt,
             )) + 
  geom_line(aes(group = individual_ID),
            alpha = 0.2) +
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.2, 
              alpha = 1) + 
  geom_point(data = mean_CEWL,
             aes(x = day,
                 y = mean_CEWL, 
                 color = tmt,
                 shape = tmt),
             size = 4, 
             alpha = 1) +
  theme_classic() + 
  scale_shape_manual(values = c(15:18),
                     name = "") +
  scale_color_brewer(palette = "Set2",
                     name = "") +
  scale_x_continuous(breaks = c(0, 8),
                     labels = c("0" = "before", "8" = "after")
                     ) +
  xlab("") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 20),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14,
                                 angle = 90),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = c(0.25,0.85)
) -> tmt_effects_CEWL
tmt_effects_CEWL

# export figure
ggsave(filename = "tmt_effects_CEWL.jpeg",
       plot = tmt_effects_CEWL,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 5, height = 4)
```






# Experiment Models

## SMI

```{r SMI exp model 1}
SMI_mod1 <- lme4::lmer(data = dat_no_rehab,
                       SMI ~ 
                         day_n*humidity_tmt*temp_tmt +
                         (1|trial_number/individual_ID))
summary(SMI_mod1)
drop1(SMI_mod1)
```

The full model is the best model based on AIC, but the interaction between acclimation temp & humidity has such a small t-value, I want to try dropping it.

```{r SMI exp model 2}
SMI_mod2 <- lme4::lmer(data = dat_no_rehab,
                       SMI ~ 
                         day_n* (humidity_tmt + temp_tmt) +
                         (1|trial_number/individual_ID))
summary(SMI_mod2)
anova(SMI_mod1, SMI_mod2)
drop1(SMI_mod2)
```

Hm, we do lose significant predictive power. What if we drop the singular effects of temp & humidity also??

```{r SMI exp model 3}
SMI_mod3 <- lme4::lmer(data = dat_no_rehab,
                       SMI ~ 
                         day_n:humidity_tmt + day_n:temp_tmt + day_n +
                         (1|trial_number/individual_ID))
summary(SMI_mod3)
anova(SMI_mod1, SMI_mod2)
anova(SMI_mod2, SMI_mod3)
drop1(SMI_mod3)
```

Well, it seems like we lose significant predictive power if we drop acclimation temp, humidity, and their interaction, so we need to retain them despite their small p-values and likely non-significance.

Check linear regression assumptions/conditions:

```{r SMI exp model assumptions}
plot(SMI_mod1)
simple.eda(residuals(SMI_mod1))
shapiro.test(residuals(SMI_mod1))
```

Save best model stats:

```{r best SMI exp model}
SMI_mod_best <- lmerTest::lmer(data = dat_no_rehab,
                       SMI ~ 
                         day_n*humidity_tmt*temp_tmt +
                         (1|trial_number/individual_ID))
summary(SMI_mod_best)
write.csv(broom.mixed::tidy(SMI_mod_best), 
          "./results_statistics/exp_effects_SMI.csv")
```



## Hematocrit

```{r hct exp model 1}
hct_mod1 <- dat_no_rehab %>%
  dplyr::filter(complete.cases(hematocrit_percent)) %>%
  lme4::lmer(data = .,
                       hematocrit_percent ~ 
                         day_n*humidity_tmt*temp_tmt +
                         (1|trial_number/individual_ID))
summary(hct_mod1)
drop1(hct_mod1)
```

Based on t-values and AIC improvements, we should remove the temp*humidity interaction as well as humidity as a standalone variable:

```{r hct exp model 2}
hct_mod2 <- dat_no_rehab %>%
  dplyr::filter(complete.cases(hematocrit_percent)) %>%
  lme4::lmer(data = .,
                       hematocrit_percent ~ 
                         day_n:humidity_tmt + day_n + temp_tmt +
                         (1|trial_number/individual_ID))
summary(hct_mod2)
anova(hct_mod1, hct_mod2)
drop1(hct_mod2)
```

We should drop the day* humidity interaction.

```{r hct exp model 3}
hct_mod3 <- dat_no_rehab %>%
  dplyr::filter(complete.cases(hematocrit_percent)) %>%
  lme4::lmer(data = .,
                       hematocrit_percent ~ 
                         day_n + temp_tmt +
                         (1|trial_number/individual_ID))
summary(hct_mod3)
anova(hct_mod2, hct_mod3)
drop1(hct_mod3)
```

We do not lose predictive power, and AIC suggests not dropping any more variables. This is the best model.


Check linear regression assumptions/conditions:

```{r hct exp model assumptions}
plot(hct_mod3)
simple.eda(residuals(hct_mod3))
shapiro.test(residuals(hct_mod3))
```

Save best model stats:


```{r best hct exp model}
hct_mod_best <- dat_no_rehab %>%
  dplyr::filter(complete.cases(hematocrit_percent)) %>%
  lmerTest::lmer(data = .,
                       hematocrit_percent ~ 
                         day_n + temp_tmt +
                         (1|trial_number/individual_ID))
summary(hct_mod_best)
write.csv(broom::tidy(hct_mod_best), 
          "./results_statistics/exp_effects_hct.csv")
```



## Osmolality

```{r osmolality exp model 1}
osml_mod1 <- dat_no_rehab %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean)) %>%
  lme4::lmer(data = .,
                       osmolality_mmol_kg_mean ~ 
                         day_n*humidity_tmt*temp_tmt +
                         (1|trial_number/individual_ID))
summary(osml_mod1)
drop1(osml_mod1)
```


Drop temperature from the 3-way interaction:

```{r osmolality exp model 2}
osml_mod2 <- dat_no_rehab %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean)) %>%
  lme4::lmer(data = .,
                       osmolality_mmol_kg_mean ~ 
                         day_n * humidity_tmt + temp_tmt +
                         (1|trial_number/individual_ID))
summary(osml_mod2)
anova(osml_mod1, osml_mod2)
drop1(osml_mod2)
```

Drop the day* humidity interaction:

```{r osmolality exp model 3}
osml_mod3 <- dat_no_rehab %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean)) %>%
  lme4::lmer(data = .,
                       osmolality_mmol_kg_mean ~ 
                         day_n + humidity_tmt + temp_tmt +
                         (1|trial_number/individual_ID))
summary(osml_mod3)
anova(osml_mod2, osml_mod3)
drop1(osml_mod3)
```


Drop humidity:


```{r osmolality exp model 4}
osml_mod4 <- dat_no_rehab %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean)) %>%
  lme4::lmer(data = .,
                       osmolality_mmol_kg_mean ~ 
                         day_n + temp_tmt +
                         (1|trial_number/individual_ID))
summary(osml_mod4)
anova(osml_mod3, osml_mod4)
drop1(osml_mod4)
```

We do not lose predictive power. Drop day:

```{r osmolality exp model 5}
osml_mod5 <- dat_no_rehab %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean)) %>%
  lme4::lmer(data = .,
                       osmolality_mmol_kg_mean ~ 
                         temp_tmt +
                         (1|trial_number/individual_ID))
summary(osml_mod5)
anova(osml_mod3, osml_mod5)
drop1(osml_mod5)
```

This is the best model, with only temperature as a predictor.

Check linear regression assumptions/conditions:

```{r osml exp model assumptions}
plot(osml_mod5)
simple.eda(residuals(osml_mod5))
shapiro.test(residuals(osml_mod5))
```

Save best model stats:

```{r best osml exp model}
osml_mod_best <- dat_no_rehab %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean)) %>%
  lmerTest::lmer(data = .,
                       osmolality_mmol_kg_mean ~ 
                         temp_tmt + 
                         (1|trial_number/individual_ID))
summary(osml_mod_best)
write.csv(broom::tidy(osml_mod_best), 
          "./results_statistics/exp_effects_osml.csv")
```


## CEWL

```{r CEWL model 1a}
CEWL_mod1a <- lme4::lmer(data = dat_no_rehab,
                        CEWL_g_m2h_mean ~ 
                         day_n*humidity_tmt*temp_tmt +
                         cloacal_temp_C + 
                         (1|trial_number/individual_ID))
summary(CEWL_mod1a)
drop1(CEWL_mod1a)
```

Actually, re-run without individual ID as a random effect, since it accounts for none of the variation in CEWL:

```{r CEWL model 1b}
CEWL_mod1b <- lme4::lmer(data = dat_no_rehab,
                        CEWL_g_m2h_mean ~ 
                         day_n*humidity_tmt*temp_tmt +
                         cloacal_temp_C + 
                         (1|trial_number))
summary(CEWL_mod1b)
drop1(CEWL_mod1b)
```


Based on AIC, this is the best model. Based on t-values, let's try dropping the individual effects of temperature and humidity since they have the lowest t-values.

```{r CEWL model 2}
CEWL_mod2 <- lme4::lmer(data = dat_no_rehab,
                        CEWL_g_m2h_mean ~ 
                         day_n:humidity_tmt:temp_tmt +
                          humidity_tmt:temp_tmt +
                          day_n:temp_tmt +
                          day_n:humidity_tmt +
                          day_n +
                         cloacal_temp_C + 
                         (1|trial_number))
summary(CEWL_mod2)
anova(CEWL_mod1b, CEWL_mod2)
drop1(CEWL_mod2)
```

It seems like we lost no predictive power.
We can try dropping the interaction between temperature and humidity:

```{r CEWL model 3}
CEWL_mod3 <- lme4::lmer(data = dat_no_rehab,
                        CEWL_g_m2h_mean ~ 
                         day_n:humidity_tmt:temp_tmt +
                          day_n:temp_tmt +
                          day_n:humidity_tmt +
                          day_n +
                         cloacal_temp_C + 
                         (1|trial_number))
summary(CEWL_mod3)
anova(CEWL_mod2, CEWL_mod3)
drop1(CEWL_mod3)
```

This model has a lower AIC than the previous model, all the remaining t-values are large, and we lose no predictive power. This is the best model.

Check linear regression assumptions/conditions:

```{r CEWL exp model assumptions}
plot(CEWL_mod3)
simple.eda(residuals(CEWL_mod3))
shapiro.test(residuals(CEWL_mod3))
```

Save best model stats:

```{r best CEWL model}
CEWL_mod_best <- lmerTest::lmer(data = dat_no_rehab,
                        CEWL_g_m2h_mean ~ 
                         day_n:humidity_tmt:temp_tmt +
                          day_n:temp_tmt +
                          day_n:humidity_tmt +
                          day_n +
                         cloacal_temp_C + 
                         (1|trial_number))
summary(CEWL_mod_best)
write.csv(broom::tidy(CEWL_mod_best), 
          "./results_statistics/exp_effects_CEWL.csv")
```



## Conclusion

The change in body condition due to experimental treatment was best described by the full model including time in acclimation treatment, acclimation temperature, acclimation humidity, and both pairwise and three-way interactions. Hematocrit was best-predicted by a reduced model including time in acclimation treatment and acclimation temperature. Plasma osmolality was best-predicted by a reduced model including only acclimation temperature In model selection for hematocrit and plasma osmolality, each dropped variable only improved the model by <2-delta-AIC, so each stepwise model predicted the variability in the response variable equally well. However, the variables dropped also had very low t-values, evidence for their lack of influence thus exclusion from the model. The best model to predict the changes in CEWL included time in acclimation treatment, its interactions with acclimation temperature and acclimation humidity, and their three-way interaction. Nested effects of trial number and individual lizard ID were included as random effects in the LMMs predicting body condition, hematocrit, and plasma osmolality. Individual ID did not account for any variation in CEWL, so only trial number was included as a random effect in that model.





# Rehydration Figures


## SMI

```{r SMI rehydration fig}
# calculate means to overlay
mean_SMI_rehab <- dat %>%
  dplyr::filter(type == "rehab") %>%
  dplyr::filter(complete.cases(SMI)) %>%
  group_by(tmt) %>%
  summarise(day = 10,
            mean_SMI = mean(SMI))

# plot!!
dat_for_rehab %>% 
  ggplot(aes(x = day_n,
             y = SMI, 
             color = tmt,
             )) + 
  geom_line(aes(group = individual_ID),
            alpha = 0.2) +
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.2, 
              alpha = 1 ) + 
  # this point is more for the legend than for showing means
  geom_point(data = mean_SMI_rehab,
             aes(x = day,
                 y = mean_SMI,
                 color = tmt,
                 shape = tmt),
             size = 4, 
             alpha = 1) +
  theme_classic() + 
  scale_shape_manual(values = c(15:18), name = "") +
  scale_x_continuous(breaks = c(8, 10)) +
  scale_color_brewer(palette = "Set2", name = "") +
  xlab("") + 
  ylab("Body Condition (g)") + 
  guides(shape = guide_legend(nrow = 2, byrow = TRUE)) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 22),
        legend.text.align = 0,
        legend.position = "none"
) -> rehab_effects_SMI
rehab_effects_SMI

# export figure
ggsave(filename = "rehab_effects_SMI.jpeg",
       plot = rehab_effects_SMI,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 4)
```




## Hematocrit

```{r hct rehydration fig}
# calculate means to overlay
mean_hct_rehab <- dat %>%
  dplyr::filter(type == "rehab") %>%
  dplyr::filter(complete.cases(hematocrit_percent)) %>%
  group_by(tmt) %>%
  summarise(day = 10,
            mean_hct = mean(hematocrit_percent))
# plot
dat_for_rehab %>% 
  dplyr::filter(complete.cases(hematocrit_percent)) %>%
  ggplot(aes(x = day_n,
             y = hematocrit_percent, 
             color = tmt,
             )) +
  geom_line(aes(group = individual_ID),
            alpha = 0.2) +
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.2, 
              alpha = 1 ) + 
  # this point is more for the legend than for showing means
  geom_point(data = mean_hct_rehab,
             aes(x = day,
                 y = mean_hct, 
                 color = tmt,
                 shape = tmt),
             size = 4, 
             alpha = 1) +
  theme_classic() + 
  scale_shape_manual(values = c(15:18), name = "") +
  scale_x_continuous(breaks = c(8, 10)) +
  scale_color_brewer(palette = "Set2", name = "") +
  xlab("") + 
  ylab("Hematocrit (%)") + 
  guides(shape = guide_legend(nrow = 2, byrow = TRUE)) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 22),
        legend.text.align = 0,
        legend.position = "none"
        ) -> rehab_effects_hct
rehab_effects_hct

# export figure
ggsave(filename = "rehab_effects_hct.jpeg",
       plot = rehab_effects_hct,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 4)
```





## Osmolality

```{r osmolality rehydration fig}
# calculate means to overlay
mean_osml_rehab <- dat %>%
  dplyr::filter(type == "rehab") %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean)) %>%
  group_by(tmt) %>%
  summarise(day = 10,
            mean_osml = mean(osmolality_mmol_kg_mean))
# plot
dat_for_rehab %>% 
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean)) %>% 
  ggplot(aes(x = day_n,
             y = osmolality_mmol_kg_mean, 
             color = tmt,
             )) + 
  geom_line(aes(group = individual_ID),
            alpha = 0.2) +
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.2, 
              alpha = 1 ) + 
  # this point is more for the legend than for showing means
  geom_point(data = mean_osml_rehab,
             aes(x = day,
                 y = mean_osml,
                 color = tmt,
                 shape = tmt),
             size = 4, 
             alpha = 1) +
  theme_classic() + 
  scale_shape_manual(values = c(15:18), name = "") +
  scale_x_continuous(breaks = c(8, 10)) +
  scale_color_brewer(palette = "Set2", name = "") +
  xlab("Day") + 
  ylab("Osmolality (mmol / kg)") + 
  guides(shape = guide_legend(nrow = 2, byrow = TRUE)) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 22),
        legend.text.align = 0,
        legend.position = "bottom"
        ) -> rehab_effects_osml
rehab_effects_osml

# export figure
ggsave(filename = "rehab_effects_osml.jpeg",
       plot = rehab_effects_osml,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 4)
```



## Multi-Figure

```{r arrange rehydration figs}
ggarrange(rehab_effects_SMI,
          rehab_effects_hct,
          rehab_effects_osml,
          ncol = 1, nrow = 3,
          common.legend = TRUE,
          legend = "bottom"
          ) -> rehab_multi_fig
rehab_multi_fig
# export figure
ggsave(filename = "rehab_multi_fig.jpeg",
       plot = rehab_multi_fig,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 12)
```



# Exp -> Rehydration Figure

## SMI

```{r SMI fig}
ggplot() + 
  geom_line(data = dat_no_rehab,
            aes(x = day_n,
             y = SMI, 
             color = tmt,
             group = individual_ID),
            alpha = 0.2) +
  geom_line(data = dat_for_rehab,
            aes(x = day_n,
             y = SMI, 
             color = tmt,
             group = individual_ID),
            alpha = 0.2) +
  stat_smooth(data = dat_no_rehab,
    aes(x = day_n,
             y = SMI, 
             color = tmt,
             group = tmt),
            formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.2, 
              alpha = 1 ) + 
  stat_smooth(data = dat_for_rehab,
    aes(x = day_n,
             y = SMI, 
             color = tmt,
             group = tmt),
            formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.2, 
              alpha = 1 ) + 
  geom_point(data = mean_SMI,
             aes(x = day,
                 y = mean_SMI - 0.1, # slight adjustment to center on line
                 color = tmt,
                 shape = tmt),
             size = 4, 
             alpha = 1) +
  geom_point(data = mean_SMI_rehab,
             aes(x = day,
                 y = mean_SMI,
                 color = tmt,
                 shape = tmt),
             size = 4, 
             alpha = 1) +
  theme_classic() + 
  scale_shape_manual(values = c(15:18), name = "") +
  scale_x_continuous(breaks = c(0, 2, 4, 6, 8, 10)) +
  scale_color_brewer(palette = "Set2", name = "") +
  xlab("Day") + 
  ylab("Body Condition (g)") + 
  guides(shape = guide_legend(nrow = 2, byrow = TRUE)) +
  geom_vline(xintercept = 9,
             linetype = "dashed",
             color = "darkgrey") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 22),
        legend.text.align = 0,
        legend.position = "none"
) -> overall_fig_SMI
overall_fig_SMI

# export figure
ggsave(filename = "overall_fig_SMI.jpeg",
       plot = overall_fig_SMI,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 4)
```





## Hct

```{r hct fig}
# need to scrub data
dat_for_rehab1 <- dat_for_rehab %>%
  dplyr::filter(complete.cases(hematocrit_percent))
dat_no_rehab1 <- dat_no_rehab %>%
  dplyr::filter(complete.cases(hematocrit_percent))

# plot
ggplot() +
  geom_line(data = dat_no_rehab1,
            aes(x = day_n,
             y = hematocrit_percent, 
             color = tmt,
             group = individual_ID),
            alpha = 0.2) +
  geom_line(data = dat_for_rehab1,
            aes(x = day_n,
             y = hematocrit_percent, 
             color = tmt,
             group = individual_ID),
            alpha = 0.2) +
  stat_smooth(data = dat_no_rehab1,
            aes(x = day_n,
             y = hematocrit_percent, 
             color = tmt,
             group = tmt),
            formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.2, 
              alpha = 1 ) + 
  stat_smooth(data = dat_for_rehab1,
            aes(x = day_n,
             y = hematocrit_percent, 
             color = tmt,
             group = tmt),
            formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.2, 
              alpha = 1 ) + 
  geom_point(data = mean_hct,
             aes(x = day,
                 y = mean_hct, 
                 color = tmt,
                 shape = tmt),
             size = 4, 
             alpha = 1) +
  geom_point(data = mean_hct_rehab,
             aes(x = day,
                 y = mean_hct, 
                 color = tmt,
                 shape = tmt),
             size = 4, 
             alpha = 1) +
  theme_classic() + 
  scale_shape_manual(values = c(15:18), name = "") +
  scale_x_continuous(breaks = c(0, 2, 4, 6, 8, 10)) +
  scale_color_brewer(palette = "Set2", name = "") +
  xlab("") + 
  ylab("Hematocrit (%)") + 
  guides(shape = guide_legend(nrow = 2, byrow = TRUE)) +
  geom_vline(xintercept = 9,
             linetype = "dashed",
             color = "darkgrey") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 22),
        legend.text.align = 0,
        legend.position = "none"
        ) -> overall_fig_hct
overall_fig_hct

# export figure
ggsave(filename = "overall_fig_hct.jpeg",
       plot = overall_fig_hct,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 4)
```





## Osmolality


```{r osmolality fig}
# need to scrub data
dat_for_rehab2 <- dat_for_rehab %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean))
dat_no_rehab2 <- dat_no_rehab %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean))

# plot
ggplot() + 
  geom_line(data = dat_no_rehab2,
            aes(x = day_n,
             y = osmolality_mmol_kg_mean, 
             color = tmt,
             group = individual_ID),
            alpha = 0.2) +
  geom_line(data = dat_for_rehab2,
            aes(x = day_n,
             y = osmolality_mmol_kg_mean, 
             color = tmt,
             group = individual_ID),
            alpha = 0.2) +
  stat_smooth(data = dat_no_rehab2,
            aes(x = day_n,
             y = osmolality_mmol_kg_mean, 
             color = tmt,
             group = tmt),
            formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.2, 
              alpha = 1 ) + 
  stat_smooth(data = dat_for_rehab2,
            aes(x = day_n,
             y = osmolality_mmol_kg_mean, 
             color = tmt,
             group = tmt),
            formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.2, 
              alpha = 1 ) + 
  geom_point(data = mean_osml,
             aes(x = day,
                 y = mean_osml + 3, # slight adjust to center on line 
                 color = tmt,
                 shape = tmt),
             size = 4, 
             alpha = 1) +
  geom_point(data = mean_osml_rehab,
             aes(x = day,
                 y = mean_osml,
                 color = tmt,
                 shape = tmt),
             size = 4, 
             alpha = 1) +
  theme_classic() + 
  scale_shape_manual(values = c(15:18), name = "") +
  scale_x_continuous(breaks = c(0, 2, 4, 6, 8, 10)) +
  scale_color_brewer(palette = "Set2", name = "") +
  xlab("") + 
  ylab("Osmolality (mmol / kg)") + 
  guides(shape = guide_legend(nrow = 2, byrow = TRUE)) +
  geom_vline(xintercept = 9,
             linetype = "dashed",
             color = "darkgrey") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 22),
        legend.text.align = 0,
        legend.position = "bottom"
        ) -> overall_fig_osml
overall_fig_osml

# export figure
ggsave(filename = "overall_fig_osml.jpeg",
       plot = overall_fig_osml,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 4)
```



## Multi-Figure

```{r arrange figs}
ggarrange(overall_fig_osml,
          overall_fig_hct,
          overall_fig_SMI,
          ncol = 1, nrow = 3,
          common.legend = TRUE,
          legend = "bottom"
          ) -> overall_multi_fig
overall_multi_fig
# export figure
ggsave(filename = "overall_multi_fig.jpeg",
       plot = overall_multi_fig,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 12)
```







# Rehydration Models


## SMI

```{r SMI rehydration model 1}
SMI_rmod1 <- lme4::lmer(data = dat_for_rehab,
                       SMI ~ 
                         type*humidity_tmt*temp_tmt +
                         (1|trial_number/individual_ID))
summary(SMI_rmod1)
drop1(SMI_rmod1)
```

Remove three-way interaction and day*humidity interaction.

```{r SMI rehydration model 2}
SMI_rmod2 <- lme4::lmer(data = dat_for_rehab,
                       SMI ~ 
                         type*temp_tmt + humidity_tmt +
                         (1|trial_number/individual_ID))
summary(SMI_rmod2)
drop1(SMI_rmod2)
```

Remove temperature and humidity single effects:

```{r SMI rehydration model 3}
SMI_rmod3 <- lme4::lmer(data = dat_for_rehab,
                       SMI ~ 
                         type:temp_tmt + type +
                         (1|trial_number/individual_ID))
summary(SMI_rmod3)
drop1(SMI_rmod3)
```

This is the best model.

Check linear regression assumptions/conditions:

```{r SMI rehydration model assumptions}
plot(SMI_rmod3)
simple.eda(residuals(SMI_rmod3))
shapiro.test(residuals(SMI_rmod3))
```

Save best model stats:

```{r best SMI rehydration model}
SMI_rmod_best <- lmerTest::lmer(data = dat_for_rehab,
                       SMI ~ 
                         type:temp_tmt + type +
                         (1|trial_number/individual_ID))
summary(SMI_rmod_best)
write.csv(broom.mixed::tidy(SMI_rmod_best), 
          "./results_statistics/rehab_effects_SMI.csv")
```



## Hematocrit

```{r hct rehydration model 1}
hct_rmod1 <- dat_for_rehab %>%
  dplyr::filter(complete.cases(hematocrit_percent)) %>%
  lme4::lmer(data = .,
                       hematocrit_percent ~ 
                         type*humidity_tmt*temp_tmt +
                         (1|trial_number/individual_ID))
summary(hct_rmod1)
drop1(hct_rmod1)
```

Remove humidity from the three-way interaction:

```{r hct rehydration model 2}
hct_rmod2 <- dat_for_rehab %>%
  dplyr::filter(complete.cases(hematocrit_percent)) %>%
  lme4::lmer(data = .,
                       hematocrit_percent ~ 
                         type*temp_tmt + humidity_tmt +
                         (1|trial_number/individual_ID))
summary(hct_rmod2)
drop1(hct_rmod2)
```


Drop humidity from the model completely:

```{r hct rehydration model 3}
hct_rmod3 <- dat_for_rehab %>%
  dplyr::filter(complete.cases(hematocrit_percent)) %>%
  lme4::lmer(data = .,
                       hematocrit_percent ~ 
                         type * temp_tmt +
                         (1|trial_number/individual_ID))
summary(hct_rmod3)
drop1(hct_rmod3)
```

The model is the same whether we drop the interaction or not, so we choose to drop it to simplify the model.

```{r hct rehydration model 4}
hct_rmod4 <- dat_for_rehab %>%
  dplyr::filter(complete.cases(hematocrit_percent)) %>%
  lme4::lmer(data = .,
                       hematocrit_percent ~ 
                         type + temp_tmt +
                         (1|trial_number/individual_ID))
summary(hct_rmod4)
drop1(hct_rmod4)
```

This seems to be the best model.

Check linear regression assumptions/conditions:

```{r hct rehydration model assumptions}
plot(hct_rmod4)
simple.eda(residuals(hct_rmod4))
shapiro.test(residuals(hct_rmod4))
```

Save best model stats:

```{r best hct rehydration model}
hct_rmod_best <- dat_for_rehab %>%
  dplyr::filter(complete.cases(hematocrit_percent)) %>%
  lmerTest::lmer(data = .,
                       hematocrit_percent ~ 
                         type + temp_tmt +
                         (1|trial_number/individual_ID))
summary(hct_rmod_best)
write.csv(broom::tidy(hct_rmod_best), 
          "./results_statistics/rehab_effects_hct.csv")
```



## Osmolality

```{r osmolality rehydration model 1}
osml_rmod1 <- dat_for_rehab %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean)) %>%
  lme4::lmer(data = .,
                       osmolality_mmol_kg_mean ~ 
                         type*humidity_tmt*temp_tmt +
                         (1|trial_number/individual_ID))
summary(osml_rmod1)
drop1(osml_rmod1)
```

Drop the interaction with day:

```{r osmolality rehydration model 2}
osml_rmod2 <- dat_for_rehab %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean)) %>%
  lme4::lmer(data = .,
                       osmolality_mmol_kg_mean ~ 
                         type + humidity_tmt*temp_tmt +
                         (1|trial_number/individual_ID))
summary(osml_rmod2)
drop1(osml_rmod2)
```


Drop the interaction between temperature and humidity:

```{r osmolality rehydration model 3}
osml_rmod3 <- dat_for_rehab %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean)) %>%
  lme4::lmer(data = .,
                       osmolality_mmol_kg_mean ~ 
                         type + humidity_tmt + temp_tmt +
                         (1|trial_number/individual_ID))
summary(osml_rmod3)
drop1(osml_rmod3)
```

Drop humidity:

```{r osmolality rehydration model 4}
osml_rmod4 <- dat_for_rehab %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean)) %>%
  lme4::lmer(data = .,
                       osmolality_mmol_kg_mean ~ 
                         type + temp_tmt +
                         (1|trial_number/individual_ID))
summary(osml_rmod4)
drop1(osml_rmod4)
```

The best model to predict the rehydration effects on plasma osmolality included only additive effects of rehab and acclimation temp tmt prior to rehab.

Check linear regression assumptions/conditions:

```{r osml rehydration model assumptions}
plot(osml_rmod4)
simple.eda(residuals(osml_rmod4))
shapiro.test(residuals(osml_rmod4))
```

Save best model stats:

```{r best osmolality rehydration model}
osml_rmod_best <- dat_for_rehab %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean)) %>%
  lmerTest::lmer(data = .,
                       osmolality_mmol_kg_mean ~ 
                         type + temp_tmt +
                         (1|trial_number/individual_ID))
summary(osml_rmod_best)
write.csv(broom::tidy(osml_rmod_best), 
          "./results_statistics/rehab_effects_osml.csv")
```




## Conclusion

During the 2-day rehydration opportunity provided to lizards following experimental climate treatment, body condition and plasma osmolality significantly increased and hematocrit significantly decreased. The change in body condition during rehydration was also effected by the interaction between rehydration and acclimation temperature prior to rehydration, with cool-acclimated lizards having overall higher body condition and showing a larger increase in body condition during rehydration. Cool-acclimated lizards also maintained higher hematocrit and lower plasma osmolality during rehydration compared to other treatment groups, although changes in hct and osml during rehydration were not different due to acclimation. Nested effects of trial number and individual lizard ID were included as random effects in all three LMMs.


This is true for pretty much all the model selection I did:
In model selection, each dropped variable only improved the model by <2-delta-AIC, so each stepwise model predicted the variability in the response variable equally well. However, the variables dropped also had very low t-values, evidence for their lack of influence thus exclusion from the model.


