---
title: "Climate Water Loss Experiment - Capture Hydration Analysis"
author: "Savannah Weaver"
date: "2021"
output: pdf_document
toc: TRUE
---


# Packages

```{r setup, include = TRUE, message = FALSE}
if (!require("tidyverse")) install.packages("tidyverse")
library("tidyverse") # workflow and plots
if (!require("zoo")) install.packages("zoo")
library("zoo") # interpolation using na.approx
if (!require("weathermetrics")) install.packages("weathermetrics")
library("weathermetrics") # F to C conversion
if (!require("lme4")) install.packages("lme4")
library("lme4") # for LMMs
if (!require("lmerTest")) install.packages("lmerTest")
library("lmerTest") # for p-values
if (!require("ggpubr")) install.packages("ggpubr")
library("ggpubr") # for multi-ggplot figs
if (!require("broom")) install.packages("broom")
library("broom") # lmer model export
if (!require("broom.mixed")) install.packages("broom.mixed")
library("broom.mixed") # lmer model export
```


# Background and Goals

This data was collected June - August by Master's student Savannah Weaver, advisor Dr. Emily Taylor, and research assistants Tess McIntyre and Taylor Van Rossum. Adult male *Sceloporus occidentalis* were caught across the Cal Poly campus and in Poly Canyon. This R file analyzes the state and variation of osmotic balance and regulation at the time of capture. Please refer to **doi:** for the published scientific journal article and full details.


# Data

## Load

Read-in and attach all data. Details described later.

```{r}
        # mass and hematocrit data
full_dat <- read.csv("./data/mass_hct_notes.csv", # filename
                             na.strings=c("","NA") # fix empty cells
                             ) %>%
        # format date to enable joining by date
  mutate(measurement_date = as.character(as.Date(measurement_date, 
                                          format = "%m/%d/%y"))
         ) %>%
        # join plasma osmolality data
  left_join(read.csv("./data/osml_means_clean.csv", # filename
                             na.strings=c("","NA") # fix empty cells
            ), by = c("individual_ID", 
                      "measurement_date" = "date_blood_drawn")
            ) %>%
        # join CEWL data
  left_join(read.csv("./data/CEWL_dat_all_clean.csv", # filename
                             na.strings=c("","NA") # fix empty cells
            ), by = c("individual_ID", 
                      "measurement_date" = "date")
            ) %>%
        # select variables of interest only
  dplyr::select(measurement_date,
                time_captured,
                time_processed,
                time_c_temp,
                type, day, 
                individual_ID,
                mass_g, 
                hemolyzed,
                hematocrit_percent, 
                osmolality_mmol_kg_mean,
                CEWL_g_m2h_mean = CEWL_g_m2h,
                cloacal_temp_C
                ) %>%
          # format date-time-related variables
  mutate(measurement_date = as.Date(measurement_date, 
                                    format = "%Y-%m-%d")) %>%
  group_by(individual_ID) %>%
          # for each individual, extract capture date
  mutate(capture_date = min(measurement_date),
         day_n = as.numeric(measurement_date - capture_date))

summary(full_dat)
# check
unique(full_dat$capture_date)
```


## Export

Export full_dat to be used in 'experiment_analysis'.

```{r}
write.csv(full_dat, "./data/full_exp_data.csv")
```


## Format

Extract only the data from capture day (1 row of observations for each individual) and format the data classes properly for analysis.

```{r}
capture_dat <- full_dat %>%
          # select only data from capture days
  dplyr::filter(day_n == 0) %>%
  left_join(read.csv("./data/tmt_assignments.csv"),
            by = "individual_ID") %>%
          # put date and time together
  mutate(capture_date_time = (paste(capture_date, time_captured)),
         capture_date_time = as.POSIXct(capture_date_time, 
                                        format = "%Y-%m-%d %H:%M"),
          # correctly format time-only variables
         time_captured = as.POSIXct(time_captured, 
                                     format = "%H:%M"),
         time_processed = as.POSIXct(time_processed, 
                                      format = "%H:%M"),
         time_c_temp = as.POSIXct(substr(time_c_temp, 12, 16), 
                                  format = "%H:%M"),
          # set categorical variables as factors
         type = as.factor(type),
         day = as.factor(day),
         individual_ID = as.factor(individual_ID),
         hemolyzed = as.factor(hemolyzed),
          # set numeric measurements as numeric
         mass_g = as.numeric(mass_g),
         hematocrit_percent = as.numeric(hematocrit_percent),
         osmolality_mmol_kg_mean = as.numeric(osmolality_mmol_kg_mean),
         CEWL_g_m2h_mean = as.numeric(CEWL_g_m2h_mean),
         cloacal_temp_C = as.numeric(cloacal_temp_C)
                ) %>%
  # make sure only complete data included
  # this removes the data for individuals 304 (recapture) & 254 (escapee)
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean,
                               CEWL_g_m2h_mean, cloacal_temp_C)) %>%
  # remove experiment variables not relevant to capture analysis
  dplyr::select(-trial_number, -temp_tmt, -humidity_tmt, 
                -conclusion, -notes, 
                -shed, -tail_broken, -died)
summary(capture_dat)
```




## Variable Summary

- measurement_date = date measurements were taken, including capture day
- collection/capture time for each lizard
- time_processed = when mass and blood draw were recorded
- time_c_temp = the time when cloacal temperature was recorded, immediately after CEWL measurements
- type = whether measurements were during experiment (exp) or after rehydration (post-rehab). For this R script/analysis, I'm only going to use capture day data, which is listed as "exp"
- day = whether measurements are from capture day or post-experiment, which was recorded in relation to CEWL & cloacal temp data. All observations used for this analysis will be from capture day
- individual ID for each lizard
- mass in grams
- hemolyzed = whether or not red blood cells burst and contaminated plasma
- hematocrit_percent = percent of blood that's red blood cells (measured in CRITOCAP microhematocrit capillary tubes)
- osmolality_mmol_kg_mean = the mean of 1-3 technical replicates of plasma osmolality measurements taken from plasma extracted from our blood samples and run on a VAPRO vapor pressure osmometer
- CEWL_g_m2h_mean = the mean of 3-5 technical replicates, after outliers were omitted, of CEWL measurements taken in the same area of the dorsum
- cloacal_temp_C = cloacal temperature recorded immediately after CEWL measurements
- capture_date = date of capture. For this dataset, it should be the same as measurement date
- day_n = numeric day of measurement. In this dataset, it should always be zero
- capture_date_time = combination of capture date and time
- SVL_mm = snout-to-vent length in mm



## Weather Data

This data was obtained from http://www.itrc.org/databases/precip/ (Adcon Server Data) to test the effect of ambient conditions on CEWL.

Load and format: 

```{r}
weather <- read.csv("./data/weather.csv", sep = ';') %>%
         # add a variable for combined date-time
  mutate(capture_date_time = as.POSIXct(paste(date, time),
                                format = "%m/%d/%y %I:%M %p"))
```

The weather data is only every 15 minutes, but I want to match it to any minute measurement, so I need to interpolate the values for each minute.

First, make a separate dataframe with every minute on each capture day.

```{r}
all_times <- data.frame(capture_date_time = c(
                           # June 16
                           seq(from = as.POSIXct("2021-06-16 07:00"),
                               to = as.POSIXct("2021-06-16 19:00"),
                               by="min"),
                           # June 26
                           seq(from = as.POSIXct("2021-06-26 07:00"),
                               to = as.POSIXct("2021-06-26 19:00"),
                               by="min"),
                           # July 20
                           seq(from = as.POSIXct("2021-07-20 07:00"),
                               to = as.POSIXct("2021-07-20 19:00"),
                               by="min"),
                           # August 8
                           seq(from = as.POSIXct("2021-08-08 07:00"),
                               to = as.POSIXct("2021-08-08 19:00"),
                               by="min"),
                           # August 22
                           seq(from = as.POSIXct("2021-08-22 07:00"),
                               to = as.POSIXct("2021-08-22 19:00"),
                               by="min")
                           ))

```

Next, merge the weather data into the times dataframe and interpolate the temperature and humidity between measurements.

```{r}
weather_every_minute <- all_times %>% # time only dataframe
  # add weather measurements based on matching date-time
  left_join(weather, by = 'capture_date_time') %>%
         # convert temperature units F->C
  mutate(temp_C = fahrenheit.to.celsius(temperature_F, round = 2),
         # interpolate temperatures
         temp_C_interpol = na.approx(temp_C),
         # also get temperature C-> K
         temp_K_interpol = temp_C_interpol + 273.15,
         # interpolate humidities
         RH_percent_interpol = na.approx(relative_humidity_percent),
         # interpolate Wind Speeds
         wind_mph_interpol = na.approx(wind_speed_mph),
         # interpolate solar radiation
         solar_rad_W_sqm_interpol = na.approx(solar_radiation_W_sqm),
         # compute vapor pressure deficit
         # find saturation level first
         e_s_kPa_int = 0.611*exp((2500000/461.5)*
                                  ((1/273)-(1/temp_K_interpol))),
         # actual vapor pressure
         e_a_kPa_int = e_s_kPa_int * (RH_percent_interpol/100),
         # VPD
         VPD_kPa_int = e_s_kPa_int - e_a_kPa_int
         ) %>%
  # keep only the relevant variables
  dplyr::select(capture_date_time, 
                temp_C_interpol, 
                RH_percent_interpol, 
                VPD_kPa_int,
                wind_mph_interpol, 
                solar_rad_W_sqm_interpol)
summary(weather_every_minute)
```

I will add the weather data in when I add the scaled mass index (computed next) to the dataframe.



## Compute Scaled Mass Index

This is also known as the body condition index, or log-log residuals.

I calculate as described by: Peig, J., & Green, A. J. (2009). New perspectives for estimating body condition from mass/length data: The scaled mass index as an alternative method. Oikos, 118(12), 1883–1891. https://doi.org/10.1111/j.1600-0706.2009.17643.x

### Step 1: Simple Linear Regression

```{r}
mass_SVL_SLR <- lm(data = capture_dat, mass_g ~ SVL_mm)
summary(mass_SVL_SLR)
```


### Step 2: Identify Outliers

```{r}
plot(mass_SVL_SLR)
```

The conditions of linearity, equal error variance, and normality are all satisfied. It doesn't look like any residuals are >3 or <-3.

```{r}
boxplot(residuals(mass_SVL_SLR))
hist(residuals(mass_SVL_SLR))
```

From the boxplot, there is one individual with a much higher residual than the rest of the distribution. The histogram looks fine, and incredibly normally distributed.

Check average residual value:

```{r}
mean(residuals(mass_SVL_SLR))
median(residuals(mass_SVL_SLR))
```

The mean is basically zero and the median is pretty close to zero, which is very good.

Check for high leverage points:

```{r}
# compute values for observations 
high_leverage <- data.frame(H = hatvalues(mass_SVL_SLR)) %>% 
  mutate(row = row_number())

# compute cutoff value 
h_bar <- (3*sum(high_leverage$H))/nrow(high_leverage)

# add to original dataframe 
# see which observations have extremely high leverage (if any)
high_leverage_dat <- capture_dat %>%
  mutate(row = row_number()) %>%
  left_join(., high_leverage, by = "row") %>%
  dplyr::filter(H > h_bar) 
high_leverage_dat
```

No points are considered high leverage, which is fantastic.

Check for influential points based on Cook's distance:

```{r}
# get Cook's distance 
cooks <- data.frame(c = cooks.distance(mass_SVL_SLR)) %>% 
  mutate(row = row_number())

# add to original dataframe 
influential <- capture_dat %>%
  mutate(row = row_number()) %>% 
  left_join(., cooks, by = "row")

# see moderately influential points 
cook_mod_inf <- influential %>% 
  dplyr::filter(c>0.5) 
cook_mod_inf
```

There are no infuential points based on Cook's distance, so there's nothing to potentially remove.

We could remove the one outlier found using the boxplot, but it's the only one, so we will leave it in the dataset. No points were indicated to be outliers based on residuals or a histogram, and there were no high leverage or influential points. Thus I can create a log-log model using the data as-is. Observation omissions are unlikely to increase generalizability.


 
### Step 3: log-log Regression

```{r}
log_mass_SVL_SLR <- lm(data = capture_dat, 
                       log(mass_g) ~ log(SVL_mm))
summary(log_mass_SVL_SLR)
```


### Step 4: Extract Values

compute standardized major axis using the log-log regression equation:

```{r}
r <- sqrt(0.5699) # Pearson's correlection coefficient (sqrt of R-squared)
b_OLS <- 2.0013 # regression slope
b_SMA <- b_OLS/r
```

mean length in capture data:

```{r}
L0 <- mean(capture_dat$SVL_mm)
```


### Step 5: Calculate Scaled Mass Index

(And join weather data.)

```{r}
capture_dat_plus <- capture_dat %>%
  # compute SMI
  mutate(SMI = mass_g * ((L0/SVL_mm) ^ b_SMA)) %>%
  # join weather data
  left_join(weather_every_minute, by = c("capture_date_time")) %>%
  # clean up the dataframe
  dplyr::select(capture_date, capture_date_time, individual_ID, # basics
                mass_g, SVL_mm, SMI, # lizard size
                hemolyzed, hematocrit_percent, osmolality_mmol_kg_mean, # blood
                CEWL_g_m2h_mean, cloacal_temp_C, # CEWL
                temp_C_interpol, VPD_kPa_int, wind_mph_interpol, solar_rad_W_sqm_interpol # weather
                )
summary(capture_dat_plus)
```


### Check

Look at the difference between regular mass and SMI:

```{r}
capture_dat_plus %>% 
  ggplot(data = .) + 
  geom_point(aes(x = mass_g,
                 y = SMI, 
                 ), 
             size = 1, 
             alpha = 0.6) + 
  stat_smooth(aes(x = mass_g, 
                  y = SMI, 
                  ), 
              formula = y ~ x, 
              method = "lm", 
              color = "gray",
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Mass") + 
  ylab("SMI")
```






# Quick Plots

Plot very basic graphs to get an idea of what variables to incorporate into models and how.

## Osmolality

```{r}
plot(capture_dat_plus$individual_ID,
     capture_dat_plus$osmolality_mmol_kg_mean)
plot(capture_dat_plus$capture_date,
     capture_dat_plus$osmolality_mmol_kg_mean)
plot(capture_dat_plus$mass_g,
     capture_dat_plus$osmolality_mmol_kg_mean)
plot(capture_dat_plus$SVL_mm,
     capture_dat_plus$osmolality_mmol_kg_mean)
plot(capture_dat_plus$SMI,
     capture_dat_plus$osmolality_mmol_kg_mean)
plot(capture_dat_plus$hemolyzed,
     capture_dat_plus$osmolality_mmol_kg_mean)
plot(capture_dat_plus$hematocrit_percent,
     capture_dat_plus$osmolality_mmol_kg_mean)
plot(capture_dat_plus$CEWL_g_m2h_mean,
     capture_dat_plus$osmolality_mmol_kg_mean)
plot(capture_dat_plus$temp_C_interpol,
     capture_dat_plus$osmolality_mmol_kg_mean)
plot(capture_dat_plus$VPD_kPa_int,
     capture_dat_plus$osmolality_mmol_kg_mean)
plot(capture_dat_plus$wind_mph_interpol,
     capture_dat_plus$osmolality_mmol_kg_mean)
plot(capture_dat_plus$solar_rad_W_sqm_interpol,
     capture_dat_plus$osmolality_mmol_kg_mean)
```

There does not appear to be a meaningful visual trend for plasma osmolality, so it will be interesting to see how the model selection process goes... There is definitely an increase in osmolality over the course of the season, though.


## CEWL

```{r}
plot(capture_dat_plus$individual_ID,
     capture_dat_plus$CEWL_g_m2h_mean)
plot(capture_dat_plus$capture_date,
     capture_dat_plus$CEWL_g_m2h_mean)
plot(capture_dat_plus$mass_g,
     capture_dat_plus$CEWL_g_m2h_mean)
plot(capture_dat_plus$SVL_mm,
     capture_dat_plus$CEWL_g_m2h_mean)
plot(capture_dat_plus$SMI,
     capture_dat_plus$CEWL_g_m2h_mean)
plot(capture_dat_plus$hematocrit_percent,
     capture_dat_plus$CEWL_g_m2h_mean)
plot(capture_dat_plus$osmolality_mmol_kg_mean,
     capture_dat_plus$CEWL_g_m2h_mean)
plot(capture_dat_plus$cloacal_temp_C,
     capture_dat_plus$CEWL_g_m2h_mean)
plot(capture_dat_plus$temp_C_interpol,
     capture_dat_plus$CEWL_g_m2h_mean)
plot(capture_dat_plus$VPD_kPa_int,
     capture_dat_plus$CEWL_g_m2h_mean)
plot(capture_dat_plus$wind_mph_interpol,
     capture_dat_plus$CEWL_g_m2h_mean)
plot(capture_dat_plus$solar_rad_W_sqm_interpol,
     capture_dat_plus$CEWL_g_m2h_mean)
```

It looks like there are meaningful differences in CEWL across individuals/dates (probably confounded), and based on cloacal temp, capture temp, capture VPD, capture wind, and capture solar radiation.



# LMMs


## Osmolality


### Model Selection

Since there are large differences in osmolality by date, but we are interested in what's different among dates, rather than the capture date itself, we will include that as a random effect in the model.

```{r, osmolality model 1}
osml_mod1 <- lme4::lmer(data = capture_dat_plus,
                          # response variable
                          osmolality_mmol_kg_mean ~ 
                          # body size
                          mass_g + SVL_mm + SMI +
                          # blood sample traits
                          hemolyzed + hematocrit_percent + 
                          # weather at the time of capture
                          temp_C_interpol * VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol +
                          # random effect
                          (1|capture_date)) 
summary(osml_mod1)
drop1(osml_mod1)
```

The model would improve the most (based on lower AIC) if we drop hematocrit.

```{r, osmolality model 2}
osml_mod2 <- lme4::lmer(data = capture_dat_plus,
                          # response variable
                          osmolality_mmol_kg_mean ~ 
                          # body size
                          mass_g + SVL_mm + SMI +
                          # blood sample traits
                          hemolyzed + 
                          # weather at the time of capture
                          temp_C_interpol * VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol +
                          # random effect
                          (1|capture_date)) 
summary(osml_mod2)
drop1(osml_mod2)

# compare to full model
anova(osml_mod1, osml_mod2)
```

Next we can drop the interaction between temperature and VPD.

```{r, osmolality model 3}
osml_mod3 <- lme4::lmer(data = capture_dat_plus,
                          # response variable
                          osmolality_mmol_kg_mean ~ 
                          # body size
                          mass_g + SVL_mm + SMI +
                          # blood
                          hemolyzed +
                          # weather at the time of capture
                          temp_C_interpol + VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol +
                          # random effect
                          (1|capture_date)) 
summary(osml_mod3)
drop1(osml_mod3)

# compare to previous model
anova(osml_mod2, osml_mod3)
```


Drop wind.

```{r, osmolality model 4}
osml_mod4 <- lme4::lmer(data = capture_dat_plus,
                          # response variable
                          osmolality_mmol_kg_mean ~ 
                          # body size
                          mass_g + SVL_mm + SMI +
                          # blood
                          hemolyzed +
                          # weather at the time of capture
                          temp_C_interpol + VPD_kPa_int +
                          solar_rad_W_sqm_interpol +
                          # random effect
                          (1|capture_date)) 
summary(osml_mod4)
drop1(osml_mod4)

# compare to previous model
anova(osml_mod3, osml_mod4)
```

Next drop mass, SMI, and whether a sample is hemolyzed.

```{r, osmolality model 5}
osml_mod5 <- lme4::lmer(data = capture_dat_plus,
                          # response variable
                          osmolality_mmol_kg_mean ~ 
                          # body size
                          SVL_mm + 
                          # weather at the time of capture
                          temp_C_interpol + VPD_kPa_int +
                          solar_rad_W_sqm_interpol +
                          # random effect
                          (1|capture_date)) 
summary(osml_mod5)
drop1(osml_mod5)

# compare to previous model
anova(osml_mod4, osml_mod5)
```

Drop temperature.

```{r, osmolality model 6}
osml_mod6 <- lme4::lmer(data = capture_dat_plus,
                          # response variable
                          osmolality_mmol_kg_mean ~ 
                          # body size
                          SVL_mm + 
                          # weather at the time of capture
                          VPD_kPa_int +
                          solar_rad_W_sqm_interpol +
                          # random effect
                          (1|capture_date)) 
summary(osml_mod6)
drop1(osml_mod6)

# compare to previous model
anova(osml_mod5, osml_mod6)
```

Drop VPD.

```{r, osmolality model 7}
# need to exclude NA data
# weird that I didn't need to do this before
cap_dat_osml_mod7 <- capture_dat_plus %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean, SVL_mm,
                               solar_rad_W_sqm_interpol, capture_date))
# model
osml_mod7 <- lme4::lmer(data = cap_dat_osml_mod7,
                          # response variable
                          osmolality_mmol_kg_mean ~ 
                          # body size
                          SVL_mm + 
                          # weather at the time of capture
                          solar_rad_W_sqm_interpol +
                          # random effect
                          (1|capture_date)) 
summary(osml_mod7)
drop1(osml_mod7)
```

It looks like osml_mod7 is the best model to explain plasma osmolality. Now we can re-run it with lmerTest to get associated p-values.

```{r}
osml_mod_best <- lmerTest::lmer(data = capture_dat_plus,
                          # response variable
                          osmolality_mmol_kg_mean ~ 
                          # body size
                          SVL_mm + 
                          # weather at the time of capture
                          solar_rad_W_sqm_interpol +
                          # random effect
                          (1|capture_date)) 
summary(osml_mod_best)
```







### LM Conditions

Check residual plots:

```{r}
plot(osml_mod_best)
simple.eda(residuals(osml_mod_best))
shapiro.test(residuals(osml_mod_best))
```

There is no clear pattern in the residuals ~ fitted plot, so linearity seems satisfied. However, the high residuals for fitted values 320-350 may violate equal error variance. The Shapiro-Wilk normality test indicates that normality is violated.


### Transform Data

To attempt to remedy unequal variance and normality, I tried transforming each response and fixed effect variable using log- and 1/ transformations. I also tried transforming more than one or all of the variables. None of these attempts improved the linear regression conditions for this model.

```{r}
osml_mod_best_t <- lmerTest::lmer(data = capture_dat_plus,
                          # response variable
                          log(osmolality_mmol_kg_mean) ~ 
                          # body size
                          SVL_mm + 
                          # weather at the time of capture
                          solar_rad_W_sqm_interpol +
                          # random effect
                          (1|capture_date)) 
plot(osml_mod_best_t)
simple.eda(residuals(osml_mod_best_t))
shapiro.test(residuals(osml_mod_best_t))
```



### Conclusion

Since transformations did not improve the conditions for the osmolality model, we will keep it as-is and report that some conditions of linear regression were not met. 

Save the model output.

```{r}
osml_best_mod_results <- broom.mixed::tidy(osml_mod_best)
write.csv(osml_best_mod_results,
          "./results_statistics/capture_osml_best_model.csv")
```


To report in paper:

The best model to predict plasma osmolality included SVL and solar radiation at the time of capture as fixed effects, with date as a random effect. The final model did not meet linear regression conditions for normality and equal error variance, but transformations of neither response nor predictor variables improved this.
During model selection, each reduced model was only 1-2-delta-AIC better than the previous model. The full model included mass, SVL, SMI, whether the blood sample was hemolyzed, percent hematocrit, and temperature, VPD, wind speed, and solar radiation at the time of capture, with date as a random effect.



## CEWL

It looks like there are meaningful differences in CEWL across individuals/dates (probably confounded), and based on cloacal temp, capture temp, capture VPD, capture wind, and capture solar radiation.



### Model Selection

Start with the full model of all potential predictor variables. We will again include date as a random effect.

```{r, CEWL model 1}
CEWL_mod1 <- lme4::lmer(data = capture_dat_plus,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # essential covariate
                          cloacal_temp_C +
                          # body size
                          mass_g + SVL_mm + SMI +
                          # blood
                          osmolality_mmol_kg_mean + hematocrit_percent + 
                          # weather at the time of capture
                          temp_C_interpol * VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol +
                          # random effect
                          (1|capture_date)) 
summary(CEWL_mod1)
drop1(CEWL_mod1)
```

We will start with dropping hematocrit.

```{r, CEWL model 2}
CEWL_mod2 <- lme4::lmer(data = capture_dat_plus,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # essential covariate
                          cloacal_temp_C +
                          # body size
                          mass_g + SVL_mm + SMI +
                          # blood
                          osmolality_mmol_kg_mean + 
                          # weather at the time of capture
                          temp_C_interpol * VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol +
                          # random effect
                          (1|capture_date)) 
summary(CEWL_mod2)
anova(CEWL_mod1, CEWL_mod2)
drop1(CEWL_mod2)
```

I'm shocked that AIC suggests dropping cloacal temperature. We know it's important, so I will retain it despite the supposed benefits to model fit.

Instead, we will try dropping SVL and SMI because they are slightly less helpful than their collinear variable, mass.

```{r, CEWL model 3}
CEWL_mod3 <- lme4::lmer(data = capture_dat_plus,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # essential covariate
                          cloacal_temp_C +
                          # body size
                          mass_g +
                          # blood
                          osmolality_mmol_kg_mean + 
                          # weather at the time of capture
                          temp_C_interpol * VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol +
                          # random effect
                          (1|capture_date)) 
summary(CEWL_mod3)
anova(CEWL_mod2, CEWL_mod3)
drop1(CEWL_mod3)
```

Drop solar radiation next:

```{r, CEWL model 4}
CEWL_mod4 <- lme4::lmer(data = capture_dat_plus,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # essential covariate
                          cloacal_temp_C +
                          # body size
                          mass_g + 
                          # blood
                          osmolality_mmol_kg_mean + 
                          # weather at the time of capture
                          temp_C_interpol * VPD_kPa_int +
                          wind_mph_interpol +
                          # random effect
                          (1|capture_date)) 
summary(CEWL_mod4)
anova(CEWL_mod3, CEWL_mod4)
drop1(CEWL_mod4)
```


Drop wind.

```{r, CEWL model 5}
CEWL_mod5 <- lme4::lmer(data = capture_dat_plus,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # essential covariate
                          cloacal_temp_C +
                          # body size
                          mass_g + 
                          # blood
                          osmolality_mmol_kg_mean + 
                          # weather at the time of capture
                          temp_C_interpol * VPD_kPa_int +
                          # random effect
                          (1|capture_date)) 
summary(CEWL_mod5)
anova(CEWL_mod4, CEWL_mod5)
drop1(CEWL_mod5)
```

Try dropping mass:

```{r, CEWL model 6}
CEWL_mod6 <- lme4::lmer(data = capture_dat_plus,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # essential covariate
                          cloacal_temp_C +
                          # blood
                          osmolality_mmol_kg_mean + 
                          # weather at the time of capture
                          temp_C_interpol * VPD_kPa_int +
                          # random effect
                          (1|capture_date)) 
summary(CEWL_mod6)
anova(CEWL_mod5, CEWL_mod6)
drop1(CEWL_mod6)
```

It looks like CEWL_mod6 is the best model to explain CEWL. Now we can re-run it with lmerTest to get associated p-values.

```{r}
CEWL_mod_best <- lmerTest::lmer(data = capture_dat_plus,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # essential covariate
                          cloacal_temp_C +
                          # blood
                          osmolality_mmol_kg_mean + 
                          # weather at the time of capture
                          temp_C_interpol * VPD_kPa_int +
                          # random effect
                          (1|capture_date)) 
summary(CEWL_mod_best)
```


### LM Conditions

Check that the best model meets the criteria for linear regression.

```{r}
plot(CEWL_mod_best)
simple.eda(residuals(CEWL_mod_best))
shapiro.test(residuals(CEWL_mod_best))
```

There is some slight fanning in the residuals ~ fitted plot, suggesting equal error variance is not perfect, but overall, all LNE conditions appear to be met.


### Conclusion

Save the model output.

```{r}
CEWL_best_mod_results <- broom.mixed::tidy(CEWL_mod_best)
write.csv(CEWL_best_mod_results,
          "./results_statistics/capture_CEWL_best_model.csv")
```


To report in paper:

The best model to predict CEWL included cloacal temperature, plasma osmolality, temperature and VPD at the time of capture, and their interaction, with date as a random effect. The final model met all linear regression conditions for linearity, normality, and equal error variance.
During model selection, each reduced model was only 1-2-delta-AIC better than the previous model. The full model included cloacal temperature, mass, SVL, SMI, plasma osmolality, percent hematocrit, and temperature, VPD, wind speed, and solar radiation at the time of capture, with date as a random effect. The effect of cloacal temperature was not significant and should have been dropped from the model based on AIC, but the literature and our previous study suggest that cloacal temperature is an strong covariate of CEWL, so we retained it in the reduced model despite nonsignificance.



# Model Figures

## Osmolality ~ SVL

```{r}
capture_dat_plus %>% 
  ggplot() + 
  geom_point(aes(x = SVL_mm,
                 y = osmolality_mmol_kg_mean), 
             size = 1, 
             alpha = 0.4) + 
  stat_smooth(aes(x = SVL_mm, 
                  y = osmolality_mmol_kg_mean), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Snout-Vent Length (mm)") + 
  ylab("Plasma Osmolality (mmol/kg)") + 
  #ylab("") +
  #xlim() +
  #ylim() +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(R) ^ 2, \" = 0.\")", 
    #       parse = TRUE,
     #      size = 6) +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(p), \" < 0.0001\")", 
    #       parse = TRUE,
     #      size = 6) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_osml_SVL_fig
cap_osml_SVL_fig
# export figure
#ggsave(filename = "cap_osml_mass_fig.jpeg",
 #      plot = cap_osml_mass_fig,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


## Osmolality ~ Solar Radiation

```{r}
capture_dat_plus %>% 
  ggplot() + 
  geom_point(aes(x = solar_rad_W_sqm_interpol,
                 y = osmolality_mmol_kg_mean), 
             size = 1, 
             alpha = 0.4) + 
  stat_smooth(aes(x = solar_rad_W_sqm_interpol, 
                  y = osmolality_mmol_kg_mean), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab(bquote('Solar Radiation (W/'*m^2*')')) + 
  ylab("Plasma Osmolality (mmol/kg)") + 
  #ylab("") +
  #xlim() +
  #ylim() +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(R) ^ 2, \" = 0.\")", 
    #       parse = TRUE,
     #      size = 6) +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(p), \" < 0.0001\")", 
    #       parse = TRUE,
     #      size = 6) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_osml_sorad_fig
cap_osml_sorad_fig
# export figure
#ggsave(filename = "cap_osml_mass_fig.jpeg",
 #      plot = cap_osml_mass_fig,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


## Osmolality ~ Date

```{r}
capture_dat_plus %>% 
  ggplot() + 
  geom_point(aes(x = capture_date,
                 y = osmolality_mmol_kg_mean), 
             size = 1, 
             alpha = 0.4) + 
  stat_smooth(aes(x = capture_date, 
                  y = osmolality_mmol_kg_mean), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Date") + 
  ylab("Plasma Osmolality (mmol/kg)") + 
  #ylab("") +
  #xlim() +
  #ylim() +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(R) ^ 2, \" = 0.\")", 
    #       parse = TRUE,
     #      size = 6) +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(p), \" < 0.0001\")", 
    #       parse = TRUE,
     #      size = 6) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_osml_date_fig
cap_osml_date_fig
# export figure
#ggsave(filename = "cap_osml_mass_fig.jpeg",
 #      plot = cap_osml_mass_fig,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```




## CEWL ~ Cloacal Temperature

```{r}
capture_dat_plus %>% 
  ggplot() + 
  geom_point(aes(x = cloacal_temp_C,
                 y = CEWL_g_m2h_mean), 
             size = 1, 
             alpha = 0.4) + 
  stat_smooth(aes(x = cloacal_temp_C, 
                  y = CEWL_g_m2h_mean), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Cloacal Temperature (°C)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #ylab("") +
  #xlim() +
  #ylim() +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(R) ^ 2, \" = 0.\")", 
    #       parse = TRUE,
     #      size = 6) +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(p), \" < 0.0001\")", 
    #       parse = TRUE,
     #      size = 6) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_CEWL_clotemp_fig
cap_CEWL_clotemp_fig
# export figure
#ggsave(filename = "cap_osml_mass_fig.jpeg",
 #      plot = cap_osml_mass_fig,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


## CEWL ~ Plasma Osmolality

```{r}
capture_dat_plus %>% 
  ggplot() + 
  geom_point(aes(x = osmolality_mmol_kg_mean,
                 y = CEWL_g_m2h_mean), 
             size = 1, 
             alpha = 0.4) + 
  stat_smooth(aes(x = osmolality_mmol_kg_mean, 
                  y = CEWL_g_m2h_mean), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Plasma Osmolality (mmol/kg)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #ylab("") +
  #xlim() +
  #ylim() +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(R) ^ 2, \" = 0.\")", 
    #       parse = TRUE,
     #      size = 6) +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(p), \" < 0.0001\")", 
    #       parse = TRUE,
     #      size = 6) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_CEWL_osml_fig
cap_CEWL_osml_fig
# export figure
#ggsave(filename = "cap_osml_mass_fig.jpeg",
 #      plot = cap_osml_mass_fig,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```



## CEWL ~ Temperature at Capture

```{r}
capture_dat_plus %>% 
  ggplot() + 
  geom_point(aes(x = temp_C_interpol,
                 y = CEWL_g_m2h_mean), 
             size = 1, 
             alpha = 0.4) + 
  stat_smooth(aes(x = temp_C_interpol, 
                  y = CEWL_g_m2h_mean), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Temperature at Capture (°C)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #ylab("") +
  #xlim() +
  #ylim() +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(R) ^ 2, \" = 0.\")", 
    #       parse = TRUE,
     #      size = 6) +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(p), \" < 0.0001\")", 
    #       parse = TRUE,
     #      size = 6) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_CEWL_temp_fig
cap_CEWL_temp_fig
# export figure
#ggsave(filename = "cap_osml_mass_fig.jpeg",
 #      plot = cap_osml_mass_fig,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


## CEWL ~ VPD at Capture

```{r}
capture_dat_plus %>% 
  ggplot() + 
  geom_point(aes(x = VPD_kPa_int,
                 y = CEWL_g_m2h_mean), 
             size = 1, 
             alpha = 0.4) + 
  stat_smooth(aes(x = VPD_kPa_int, 
                  y = CEWL_g_m2h_mean), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Vapor Pressure Deficit (kPa)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #ylab("") +
  #xlim() +
  #ylim() +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(R) ^ 2, \" = 0.\")", 
    #       parse = TRUE,
     #      size = 6) +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(p), \" < 0.0001\")", 
    #       parse = TRUE,
     #      size = 6) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_CEWL_VPD_fig
cap_CEWL_VPD_fig
# export figure
#ggsave(filename = "cap_osml_mass_fig.jpeg",
 #      plot = cap_osml_mass_fig,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


## CEWL ~ Date

```{r}
capture_dat_plus %>% 
  ggplot() + 
  geom_point(aes(x = capture_date,
                 y = CEWL_g_m2h_mean), 
             size = 1, 
             alpha = 0.4) + 
  stat_smooth(aes(x = capture_date, 
                  y = CEWL_g_m2h_mean), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Date") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #ylab("") +
  #xlim() +
  #ylim() +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(R) ^ 2, \" = 0.\")", 
    #       parse = TRUE,
     #      size = 6) +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(p), \" < 0.0001\")", 
    #       parse = TRUE,
     #      size = 6) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_CEWL_date_fig
cap_CEWL_date_fig
# export figure
#ggsave(filename = "cap_osml_mass_fig.jpeg",
 #      plot = cap_osml_mass_fig,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```





















