---
title: "Climate Water Loss Experiment - Treatment Hydration Analysis"
author: "Savannah Weaver"
date: "2021"
output: pdf_document
toc: TRUE
---

# Packages

```{r setup, include = TRUE}
`%nin%` = Negate(`%in%`)
if (!require("tidyverse")) install.packages("tidyverse")
library("tidyverse") # workflow and plots
if (!require("lme4")) install.packages("lme4")
library("lme4") # for LMMs
if (!require("lmerTest")) install.packages("lmerTest")
library("lmerTest") # for p-values
if (!require("ggpubr")) install.packages("ggpubr")
library("ggpubr") # for multi-ggplot figs
if (!require("broom")) install.packages("broom")
library("broom") # lmer model export
if (!require("broom.mixed")) install.packages("broom.mixed")
library("broom.mixed") # lmer model export
```


# Background and Goals

This data was collected June - August by Master's student Savannah Weaver, advisor Dr. Emily Taylor, and research assistants Tess McIntyre and Taylor Van Rossum. Adult male *Sceloporus occidentalis* were caught across the Cal Poly campus and in Poly Canyon. This R file analyzes the effect of experimental climate treatments on their body condition, osmotic balance, and osmoregulation. Please refer to **doi:** for the published scientific journal article and full details.


# Data

## Load

Read-in data that was compiled, formatted, and checked for completeness in 'capture_analysis'. See that file for information related to the variables. Some variables need to be re-formatted because they lose their data class in export/import. Attach treatment assignments and format that data. Also compute scaled mass index using the equation derived in 'capture_analysis'.

```{r load data}
dat <- read.csv("./data/full_exp_data.csv", # main dataset
                na.strings=c("","NA")) %>%
         # reformat individual_ID to make joining easy
  mutate(individual_ID = as.numeric(individual_ID)) %>%
            # join tmt assignment info
  left_join(read.csv("./data/tmt_assignments.csv"),
            by = "individual_ID") %>%
                # remove irrelevant variables
  dplyr::select(-X, -capture_date, 
                -time_captured, -time_processed, -time_c_temp) %>%
          # format date
  mutate(measurement_date = as.Date(measurement_date,
                                    format = "%Y-%m-%d"),
         # set factor classes
         type = as.factor(type),
         day = as.factor(day),
         individual_ID = as.factor(individual_ID), 
         hemolyzed = as.factor(hemolyzed),
         trial_number = as.factor(trial_number),
         tmt = as.factor(paste(temp_tmt, humidity_tmt)),
         temp_tmt = as.factor(temp_tmt),
         humidity_tmt = as.factor(humidity_tmt),
         conclusion = as.factor(conclusion),
         # set numeric classes
         day_n = as.numeric(day_n),
         mass_g = as.numeric(mass_g),
         hematocrit_percent = as.numeric(hematocrit_percent),
         osmolality_mmol_kg_mean = as.numeric(osmolality_mmol_kg_mean),
         CEWL_g_m2h_mean = as.numeric(CEWL_g_m2h_mean),
         cloacal_temp_C = as.numeric(cloacal_temp_C),
         SVL_mm = as.numeric(SVL_mm),
         # compute scaled mass index
         SMI = mass_g * ((67.71/SVL_mm) ^ 2.65)) %>%
  # only use data from lizards who underwent the full experiment
  # this removes 21 obs for the 7 lizards who didn't complete the exp
  dplyr::filter(conclusion == "complete")
summary(dat)
```



## Clean

There are a handful of points that appear erroneous. 

Individual 239 had post-treatment CEWL >60, which is incredibly unusual for our experiment. He was in the process of shedding when we took this CEWL measurement, so we assume that his process of shedding confounded potential treatment effects, and we should remove that point from our data. We still want to use the other measurements for this individual, so we will just set that CEWL measurement as an NA.

```{r fix weird CEWL}
which(dat$CEWL_g_m2h_mean > 60)
dat[332,]
dat[332, "CEWL_g_m2h_mean"] <- NA
dat[332,]
```

Weird osmolality??



## Format

Rename some factors:

```{r rename factors}
dat$humidity_tmt <- factor(dat$humidity_tmt,
                           levels = c("humid", "dry"),
                           labels = c("Humid", "Dry"))
dat$temp_tmt <- factor(dat$temp_tmt,
                           levels = c("hot", "cool"),
                           labels = c("Hot", "Cool"))
dat$tmt <- factor(dat$tmt,
                           levels = c("hot humid", "hot dry",
                                      "cool humid", "cool dry"),
                           labels = c("Hot Humid", "Hot Dry",
                                      "Cool Humid", "Cool Dry"))
summary(dat)
```


Make a sub-dataframe without rehab data to prevent any mix-ups:

```{r sub-df}
dat_no_rehab <- dat %>%
  dplyr::filter(type == "exp")
```



## Check

Dates:

```{r check dates}
unique(dat$measurement_date)
```

Number of measurements for each lizard:

```{r check n msmts}
dat_no_rehab %>%
  group_by(individual_ID) %>%
  summarise(n = n()) %>%
  arrange(n)
```


Every lizard has 6 experimental measurements: pre-tmt, mid-tmt, post-tmt, and mass checks on each of the 3 days between mid and post-tmt.


Did any of the treatment groups inherently start out with large differences in response variables?


```{r check starting diffs}
dat %>%
  dplyr::filter(day == "capture") %>%
  group_by(tmt) %>%
  summarise(mean(mass_g),
            mean(SMI),
            mean(hematocrit_percent),
            mean(osmolality_mmol_kg_mean),
            mean(CEWL_g_m2h_mean))
```

There are slight differences, but overall the starting values across groups are more or less the same.




# Figures

## SMI

```{r SMI fig}
dat_no_rehab %>% 
  ggplot() + 
  geom_point(aes(x = day_n,
                 y = SMI, 
                 color = tmt
                 ), 
             size = 1, 
             alpha = 0.6) +
  stat_smooth(aes(x = day_n, 
                  y = SMI, 
                  color = tmt
                  ), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  geom_line(aes(x = day_n,
                y = SMI,
                group = individual_ID,
                color = tmt),
            alpha = 0.2) +
  theme_classic() + 
  scale_x_continuous(breaks = c(0, 2, 4, 6, 8)) +
  scale_color_brewer(palette = "Set2", name = "") +
  xlab("Day") + 
  ylab("Body Condition (g)") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 12),
        legend.text.align = 0,
        legend.position = "right"
) -> tmt_effects_SMI
tmt_effects_SMI

# export figure
#ggsave(filename = "tmt_effects_SMI.jpeg",
 #      plot = tmt_effects_SMI,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 8, height = 4) # width 5 without legend
```





## Hct

```{r hct fig}
dat_no_rehab %>% 
  dplyr::filter(complete.cases(hematocrit_percent)) %>%
  ggplot() + 
  geom_point(aes(x = day_n,
                 y = hematocrit_percent, 
                 color = tmt
                 ), 
             size = 1, 
             alpha = 0.6) +
  stat_smooth(aes(x = day_n, 
                  y = hematocrit_percent, 
                  color = tmt
                  ), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  geom_line(aes(x = day_n,
                y = hematocrit_percent,
                group = individual_ID,
                color = tmt),
            alpha = 0.2) +
  theme_classic() + 
  scale_x_continuous(breaks = c(0, 2, 4, 6, 8)) +
  scale_color_brewer(palette = "Set2",
                     name = "") +
  xlab("Day") + 
  ylab("Hematocrit (%)") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 12),
        #legend.text = element_text(color = "black", 
         #                        family = "sans", 
          #                       size = 10),
        legend.text.align = 0,
        legend.position = "right"
        ) -> tmt_effects_hct
tmt_effects_hct

# export figure
#ggsave(filename = "tmt_effects_hct.jpeg",
 #      plot = tmt_effects_hct,
  #     path = "./output_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 8, height = 4)
```





## Osmolality

```{r osmolality fig}
dat_no_rehab %>% 
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean)) %>% 
  ggplot() + 
  geom_point(aes(x = day_n,
                 y = osmolality_mmol_kg_mean, 
                 color = tmt
                 ), 
             size = 1, 
             alpha = 0.6) +
  stat_smooth(aes(x = day_n, 
                  y = osmolality_mmol_kg_mean, 
                  color = tmt
                  ), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  geom_line(aes(x = day_n,
                y = osmolality_mmol_kg_mean,
                group = individual_ID,
                color = tmt),
            alpha = 0.2) +
  theme_classic() + 
  scale_x_continuous(breaks = c(0, 2, 4, 6, 8)) +
  scale_color_brewer(palette = "Set2",
                     name = "") +
  xlab("Day") + 
  ylab("Osmolality (mmol / kg)") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 12),
        legend.text.align = 0,
        legend.position = "right"
        ) -> tmt_effects_osml
tmt_effects_osml

# export figure
#ggsave(filename = "tmt_effects_osml.jpeg",
 #      plot = tmt_effects_osml,
  #     path = "./output_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 8, height = 4)
```

# figure out why that group of osmolality values skyrockets...



## CEWL

```{r CEWL fig}
dat %>% 
  dplyr::filter(complete.cases(CEWL_g_m2h_mean)) %>%
  ggplot() + 
  geom_point(aes(x = day_n,
                 y = CEWL_g_m2h_mean, 
                 color = tmt
                 ), 
             size = 1, 
             alpha = 0.6) +
  geom_line(aes(x = day_n,
                y = CEWL_g_m2h_mean,
                group = individual_ID,
                color = tmt),
            alpha = 0.2) +
  stat_smooth(aes(x = day_n, 
                  y = CEWL_g_m2h_mean, 
                  color = tmt
                  ),
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1) + 
  theme_classic() + 
  scale_color_brewer(palette = "Set2",
                     name = "") +
  scale_x_continuous(breaks = c(0, 8),
                     labels = c("0" = "before", "8" = "after")
                     ) +
  xlab("") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14,
                                 angle = 90),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 12),
        legend.text.align = 0,
        legend.position = "right"
) -> tmt_effects_CEWL
tmt_effects_CEWL

# export figure
#ggsave(filename = "tmt_effects_CEWL.jpeg",
 #      plot = CEWL_tmt_fig,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```



## Multi-Figure

```{r arrange figs}
ggarrange(tmt_effects_osml, tmt_effects_SMI, 
          tmt_effects_hct, tmt_effects_CEWL,
          ncol = 2, nrow = 2,
          common.legend = TRUE,
          legend = "bottom"
          ) -> tmt_multi_fig
tmt_multi_fig
# export figure
#ggsave(filename = "tmt_multi_fig.jpeg",
 #      plot = tmt_multi_fig,
  #     path = "./final_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 12)
```




# Models

## SMI

```{r SMI model 1}
SMI_mod1 <- lme4::lmer(data = all_dat_no_rehab,
               SMI ~ day*humidity_tmt_percent +
               (1|trial_number))
summary(SMI_mod)
drop1(SMI_mod)
```

```{r run best SMI model}
SMI_mod_best
```

```{r save best SMI model}
write.csv(broom.mixed::tidy(SMI_mod_best), 
          "./best models/exp_effects_SMI.csv")
```




```{r hct model 1}
hct_mod1 <- all_dat_no_rehab %>%
  dplyr::filter(complete.cases(hematocrit_percent)) %>%
  lme4::lmer(data = .,
               hematocrit_percent ~ day + humidity_tmt_percent +
               (1|trial_number))
summary(hct_mod)
drop1(hct_mod)
```

```{r run best hct model}
SMI_mod_best
```

```{r save best hct model}
write.csv(broom::tidy(hct_mod2), 
          "./output_models/exp_effects_hct.csv")
```



singular warning - do NOT include individual ID as a random effect

```{r osmolality model 1}
osml_mod1 <- all_dat_no_rehab %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg)) %>%
  lmerTest::lmer(data = .,
               osmolality_mmol_kg ~ day * humidity_tmt_percent +
               (1|trial_number))
summary(osml_mod)
drop1(osml_mod)
```

```{r run best osml model}
osml_mod_best
```

```{r save best osml model}
write.csv(broom::tidy(osml_mod), 
          "./best models/exp_effects_osml.csv")
```


```{r CEWL model 1}
CEWL_mod1 <- lme4::lmer(data = .,
               TEWL_g_m2h ~ day * humidity_tmt_percent * region +
               cloacal_temp_C +
               (1|trial_number/individual_ID))
summary(CEWL_mod1)
drop1(CEWL_mod1)
```


```{r CEWL model 2}

```


```{r CEWL model 3}

```

```{r run best CEWL model}
CEWL_mod_best
```

```{r save best CEWL model}
write.csv(broom::tidy(CEWL_mod3), 
          "./best models/exp_effects_CEWL.csv")
```










do stats tests on how well rehydration worked??


# Rehydration Effects

## Data

First, get only the data for before experiment, after experiment, and after rehab.

```{r rehydration model}
summary(all_dat)
rehydrat_dat <- all_dat %>%
  dplyr::filter(day %in% c(0, 8, 9, 10, 11))
rehydrat_dat$day <- factor(rehydrat_dat$day,
                           levels = c(0, 8, 9, 10, 11),
                           labels = c("Before Experiment",
                                      "After Experiment",
                                      "After Experiment",
                                      "After Rehydration",
                                      "After Rehydration"))
summary(rehydrat_dat)
```


prepare summary data to overlay on plots:

```{r}
hydrat_means <- rehydrat_dat %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg, SMI, 
                               hematocrit_percent)) %>%
  group_by(humidity_tmt_percent, day) %>%
  summarise(osml_mean = mean(osmolality_mmol_kg),
            SMI_mean = mean(SMI),
            hct_mean = mean(hematocrit_percent))
hydrat_means
```



## SMI


```{r rehydration SMI fig}
ggplot() + 
  geom_point(data = rehydrat_dat,
             aes(x = day,
                 y = SMI, 
                 color = humidity_tmt_percent
                 ), 
             size = 1, 
             alpha = 0.6) + 
  geom_line(data = rehydrat_dat,
            aes(x = day,
                y = SMI,
                group = individual_ID,
                color = humidity_tmt_percent),
            alpha = 0.2) +
  geom_line(data = hydrat_means, # new data
            aes(x = day,
                y = SMI_mean,
                group = humidity_tmt_percent,
                color = humidity_tmt_percent),
            size = 1.6,
            alpha = 1) +
  theme_classic() + 
  scale_color_brewer(palette = "Set2",
                     name = "Humidity Treatment") +
  scale_x_discrete(labels = c("Before\nExperiment",
                              "After\nExperiment",
                              "After\nRehydration")) +
  xlab("") + 
  xlab("") + 
  ylab("Body Condition (g)") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 12),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "bottom"
        ) -> rehab_SMI_fig
rehab_SMI_fig

# export figure
#ggsave(filename = "rehab_SMI_fig.jpeg",
 #      plot = rehab_SMI_fig,
  #     path = "./final_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 5, height = 4)
```


## Osmolality

first, make a list of all the IDs that have a post-rehab osmolality measurement, since this has a lot of missing data

```{r rehydration osmol data}
rehab_osmols <- rehydrat_dat %>%
  dplyr::filter(day == "After Rehydration") %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg))
```


```{r rehydration osmol fig}
rehydrat_dat %>% 
  dplyr::filter(individual_ID %in% rehab_osmols$individual_ID) %>%
  ggplot(data = .) + 
  geom_point(aes(x = day,
                 y = osmolality_mmol_kg, 
                 color = humidity_tmt_percent
                 ), 
             size = 1, 
             alpha = 0.6) +
  geom_line(aes(x = day,
                y = osmolality_mmol_kg,
                group = individual_ID,
                color = humidity_tmt_percent),
            alpha = 0.2) +
  geom_line(data = hydrat_means, # new data
            aes(x = day,
                y = osml_mean,
                group = humidity_tmt_percent,
                color = humidity_tmt_percent),
            size = 1.6,
            alpha = 1) +
  theme_classic() + 
  scale_color_brewer(palette = "Set2",
                     name = "Humidity Treatment") +
  scale_x_discrete(labels = c("Before\nExperiment",
                              "After\nExperiment",
                              "After\nRehydration")) +
  xlab("") + 
  xlab("") + 
  ylab("Osmolality (mmol/kg)") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 12),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "bottom"
  ) -> rehab_osml_fig
rehab_osml_fig

# export figure
#ggsave(filename = "rehab_osml_fig.jpeg",
 #      plot = rehab_osml_fig,
  #     path = "./final_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 5, height = 4)
```



## Hematocrit

first, make a list of all the IDs that have all three measurements:

```{r rehydration hct data}
rehab_hct <- rehydrat_dat %>%
  dplyr::filter(day == "After Rehydration") %>%
  dplyr::filter(complete.cases(hematocrit_percent))
```


```{r rehydration hct fig}
rehydrat_dat %>% 
  dplyr::filter(individual_ID %in% rehab_osmols$individual_ID) %>%
  ggplot(data = .) + 
  geom_point(aes(x = day,
                 y = hematocrit_percent, 
                 color = humidity_tmt_percent
                 ), 
             size = 1, 
             alpha = 0.6) +
  geom_line(aes(x = day,
                y = hematocrit_percent,
                group = individual_ID,
                color = humidity_tmt_percent),
            alpha = 0.2) +
  geom_line(data = hydrat_means, # new data
            aes(x = day,
                y = hct_mean,
                group = humidity_tmt_percent,
                color = humidity_tmt_percent),
            size = 1.6,
            alpha = 1) +
  theme_classic() + 
  scale_color_brewer(palette = "Set2",
                     name = "Humidity Treatment") +
  scale_x_discrete(labels = c("Before\nExperiment",
                              "After\nExperiment",
                              "After\nRehydration")) +
  xlab("") + 
  ylab("Hematocrit (%)") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 12),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "bottom"
  ) -> rehab_hct_fig
rehab_hct_fig

# export figure
#ggsave(filename = "rehab_hct_fig.jpeg",
 #      plot = rehab_hct_fig,
  #     path = "./final_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 5, height = 4)
```


## Multi-Figure

```{r}
ggarrange(rehab_osml_fig, rehab_SMI_fig, rehab_hct_fig,
          ncol = 1, nrow = 3,
          common.legend = TRUE,
          legend = "bottom"
          ) -> rehab_multi_fig
rehab_multi_fig
# export figure
#ggsave(filename = "rehab_multi_fig.jpeg",
 #      plot = rehab_multi_fig,
  #     path = "./final_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 12)
```



