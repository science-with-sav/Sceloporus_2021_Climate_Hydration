---
title: "Climate Water Loss Experiment - Capture Hydration Analysis"
author: "Savannah Weaver"
date: "2021"
output: pdf_document
toc: TRUE
---


# Packages

```{r setup, include = TRUE, message = FALSE}
if (!require("tidyverse")) install.packages("tidyverse")
library("tidyverse") # workflow and plots
if (!require("lme4")) install.packages("lme4")
library("lme4") # for LMMs
if (!require("lmerTest")) install.packages("lmerTest")
library("lmerTest") # for p-values
if (!require("UsingR")) install.packages("UsingR")
library("UsingR") # simple.eda model assumption checker
if (!require("ggpubr")) install.packages("ggpubr")
library("ggpubr") # for multi-ggplot figs
if (!require("broom.mixed")) install.packages("broom.mixed")
library("broom.mixed") # lmer model export
if (!require("AICcmodavg")) install.packages("AICcmodavg")
library("AICcmodavg") # model selection
if (!require("car")) install.packages("car")
library("car") # VIFs
if (!require("AICcmodavg")) install.packages("AICcmodavg")
library("AICcmodavg") # model selection
if (!require("RColorBrewer")) install.packages("RColorBrewer")
library("RColorBrewer") # color
```


# Background and Goals

This data was collected June - August by Master's student Savannah Weaver, advisor Dr. Emily Taylor, and research assistants Tess McIntyre and Taylor Van Rossum. Adult male *Sceloporus occidentalis* were caught across the Cal Poly campus then acclimated to 4 different climate treatments. **This R file analyzes the state and variation of osmotic balance and regulation at the time of capture.** Please refer to the published scientific journal article for full details.


# Load Data

```{r}
dat <- read_rds("./data/analysis_data_capture.RDS")
summary(dat)
```


**note** IDs I do not have data for: 254, 284, 304



# LMMs

We use simple linear models here because date and individual ID do not need to be random effects: we want to know how/why values varied across dates, and each individual only has one measurement.


## Hematocrit


### Models

First, start with a full model with every probable potential predictor in it, then check for multicollinearity. 

```{r hct model 1}
hct_mod1 <- lm(data = dat,
                          # response variable
                          hematocrit_percent ~ 
                          # body size options
                          mass_g + SVL_mm + SMI +
                          # weather at the time of capture
                          temp_C_interpol * VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol
                            )
hct_mod1_VIFs <- data.frame(VIF = car::vif(hct_mod1)) %>%
  arrange(desc(VIF))
hct_mod1_VIFs
```

remove VPD*temp interaction:

```{r hct model 2}
hct_mod2 <- lm(data = dat,
                          # response variable
                          hematocrit_percent ~ 
                          # body size
                          mass_g + SVL_mm + SMI +
                          # weather at the time of capture
                          temp_C_interpol + VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol
                            )
hct_mod2_VIFs <- data.frame(VIF = car::vif(hct_mod2)) %>%
  arrange(desc(VIF))
hct_mod2_VIFs
drop1(hct_mod2)
```


drop SVL:

```{r hct model 3}
hct_mod3 <- lm(data = dat,
                          # response variable
                          hematocrit_percent ~ 
                          # body size
                          mass_g + SMI +
                          # weather at the time of capture
                          temp_C_interpol + VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol
                            )
hct_mod3_VIFs <- data.frame(VIF = car::vif(hct_mod3)) %>%
  arrange(desc(VIF))
hct_mod3_VIFs
drop1(hct_mod3)
```


drop temperature:

```{r hct model 4}
hct_mod4 <- lm(data = dat,
                          # response variable
                          hematocrit_percent ~ 
                          # body size
                          mass_g + SMI +
                          # weather at the time of capture
                          VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol
                            )
hct_mod4_VIFs <- data.frame(VIF = car::vif(hct_mod4)) %>%
  arrange(desc(VIF))
hct_mod4_VIFs
drop1(hct_mod4)
```

VIFs are all below 5 now, so start backwards selection.

Drop mass first:

```{r hct model 5}
hct_mod5 <- lm(data = dat,
                          # response variable
                          hematocrit_percent ~ 
                          # body size
                          SMI +
                          # weather at the time of capture
                          VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol
                            )
drop1(hct_mod5)
```


Drop VPD:

```{r hct model 6}
hct_mod6 <- lm(data = dat,
                          # response variable
                          hematocrit_percent ~ 
                          # body size
                          SMI +
                          # weather at the time of capture
                          wind_mph_interpol + solar_rad_W_sqm_interpol
                            )
summary(hct_mod6)
drop1(hct_mod6)
```

Drop solar:

```{r hct model 7}
hct_mod7 <- lm(data = dat,
                          # response variable
                          hematocrit_percent ~ 
                          # body size
                          SMI +
                          # weather at the time of capture
                          wind_mph_interpol
                            )
drop1(hct_mod7)
```

Drop SMI:

```{r hct model 8}
hct_mod8 <- lm(data = dat,
                          # response variable
                          hematocrit_percent ~ 
                          # weather at the time of capture
                          wind_mph_interpol
                            )
```


Finally, null model:

```{r hct null model}
hct_mod_null <- lm(data = dat,
                          # response variable
                          hematocrit_percent ~ 1)
```


### Selection

Compare models 4-8 and the null model.

```{r hct mod compare}
hct_models <- list(hct_mod4, hct_mod5, hct_mod6, hct_mod7, 
                   hct_mod8, hct_mod_null)

#specify model names
hct_mod_names <- c('(model 4) ~ Wind-C, SMI, Solar-C, VPD-C, Mass', 
                       '(model 5) ~ Wind-C, SMI, Solar-C, VPD-C', 
                       '(model 6) ~ Wind-C, SMI, Solar-C',
                       '(model 7) ~ Wind-C, SMI', 
                       '(model 8) ~ Wind-C', 
                       'null model')
#calculate AIC of each model
hct_AICc <- data.frame(aictab(cand.set = hct_models, 
                                 modnames = hct_mod_names))
hct_AICc
```


The best models are models 6 and 5.


### LM Conditions

Check that the best model meets the criteria for linear regression and has no collinearity.

```{r hct model assumptions}
vif(hct_mod6)
plot(hct_mod6)
simple.eda(residuals(hct_mod6))
shapiro.test(residuals(hct_mod6))
vif(hct_mod5)
plot(hct_mod5)
simple.eda(residuals(hct_mod5))
shapiro.test(residuals(hct_mod5))
```

Everything is almost perfect.


### Export

```{r}
write.csv(hct_AICc, "./results_statistics/capture_hct_mod_rankings.csv")
write.csv(broom.mixed::tidy(hct_mod6), 
          "./results_statistics/capture_hct_best_mod1.csv")
write.csv(broom.mixed::tidy(hct_mod5), 
          "./results_statistics/capture_hct_best_mod2.csv")
```


## Osmolality


### Models

Since there are large differences in osmolality by date, but we are interested in what's different among dates, rather than the capture date itself, we will include that as a random effect in the model.

We would also include whether or not a blood sample is hemolyzed as a random effect, but only 11 of the almost 150 samples were hemolyzed, so we will assume that any potential effects will be undetectable and/or overshadowed. We do not have concern about using those points.

First, start with a full model with every probable potential predictor in it, then check for multicollinearity.

```{r osmolality model 1}
osml_mod1 <- lme4::lmer(data = dat,
                          # response variable
                          osmolality_mmol_kg_mean ~ 
                          # body size
                          mass_g + SVL_mm + SMI +
                          # blood sample traits
                          hematocrit_percent + 
                          # weather at the time of capture
                          temp_C_interpol * VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol +
                          (1|capture_date))
osml_mod1_VIFs <- data.frame(VIF = car::vif(osml_mod1)) %>%
  arrange(desc(VIF))
osml_mod1_VIFs
```

VPD and temperature introduce a lot of collinearity, so start by dropping their interaction:

```{r osmolality model 2}
osml_mod2 <- lme4::lmer(data = dat,
                          # response variable
                          osmolality_mmol_kg_mean ~ 
                          # body size
                          mass_g + SVL_mm + SMI +
                          # blood sample traits
                          hematocrit_percent + 
                          # weather at the time of capture
                          temp_C_interpol + VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol +
                          (1|capture_date))
osml_mod2_VIFs <- data.frame(VIF = car::vif(osml_mod2)) %>%
  arrange(desc(VIF))
osml_mod2_VIFs
drop1(osml_mod2)
```

Drop mass next, since it's extremely collinear and we get slightly better AIC by dropping mass compared to SVL:

```{r osmolality model 3}
osml_mod3 <- lme4::lmer(data = dat,
                          # response variable
                          osmolality_mmol_kg_mean ~ 
                          # body size
                          SVL_mm + SMI +
                          # blood sample traits
                          hematocrit_percent + 
                          # weather at the time of capture
                          temp_C_interpol + VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol +
                          (1|capture_date))
osml_mod3_VIFs <- data.frame(VIF = car::vif(osml_mod3)) %>%
  arrange(desc(VIF))
osml_mod3_VIFs
drop1(osml_mod3)
```

Temperature is still introducing a lot of multicollinearity, so drop:

```{r osmolality model 4}
osml_mod4 <- lme4::lmer(data = dat,
                          # response variable
                          osmolality_mmol_kg_mean ~ 
                          # body size
                          SVL_mm + SMI +
                          # blood sample traits
                          hematocrit_percent + 
                          # weather at the time of capture
                          VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol +
                          (1|capture_date))
osml_mod4_VIFs <- data.frame(VIF = car::vif(osml_mod4)) %>%
  arrange(desc(VIF))
osml_mod4_VIFs
summary(osml_mod4)
drop1(osml_mod4)
```


Great, VIFs are well-within acceptable ranges. Now we can start backwards model selection.

Start by dropping wind:

```{r osmolality model 5}
osml_mod5 <- lme4::lmer(data = dat,
                          # response variable
                          osmolality_mmol_kg_mean ~ 
                          # body size
                          SVL_mm + SMI +
                          # blood sample traits
                          hematocrit_percent + 
                          # weather at the time of capture
                          VPD_kPa_int + solar_rad_W_sqm_interpol +
                          (1|capture_date))
summary(osml_mod5)
drop1(osml_mod5)
```

Drop hematocrit:

```{r osmolality model 6}
osml_mod6 <- lme4::lmer(data = dat,
                          # response variable
                          osmolality_mmol_kg_mean ~ 
                          # body size
                          SVL_mm + SMI +
                          # weather at the time of capture
                          VPD_kPa_int + solar_rad_W_sqm_interpol +
                          (1|capture_date))
summary(osml_mod6)
drop1(osml_mod6)
```

Drop SMI:

```{r osmolality model 7}
osml_mod7 <- lme4::lmer(data = dat,
                          # response variable
                          osmolality_mmol_kg_mean ~ 
                          # body size
                          SVL_mm +
                          # weather at the time of capture
                          VPD_kPa_int + solar_rad_W_sqm_interpol +
                          (1|capture_date))
summary(osml_mod7)
drop1(osml_mod7)
```

Drop VPD:

```{r osmolality model 8}
osml_mod8 <- lme4::lmer(data = dat,
                          # response variable
                          osmolality_mmol_kg_mean ~ 
                          # body size
                          SVL_mm +
                          # weather at the time of capture
                          solar_rad_W_sqm_interpol +
                          (1|capture_date))
summary(osml_mod8)
```

Drop SVL:

```{r osmolality model 9}
osml_mod9 <- lme4::lmer(data = dat,
                          # response variable
                          osmolality_mmol_kg_mean ~ 
                          # weather at the time of capture
                          solar_rad_W_sqm_interpol +
                          (1|capture_date))
summary(osml_mod9)
```

Lastly, compute null model:

```{r osmolality null model}
osml_mod_null <- lme4::lmer(data = dat,
                          osmolality_mmol_kg_mean ~ 1 +
                          (1|capture_date))
summary(osml_mod_null)
```


### Selection

Compare models 4-9 and null. 

```{r osml mod compare}
osml_models <- list(osml_mod4, osml_mod5, osml_mod6,
                    osml_mod7, osml_mod8, osml_mod9,
                    osml_mod_null)
#specify model names
osml_mod_names <- c('(model 4) ~ Solar-C, SVL, VPD-C, SMI, Hct, Wind-C', 
                       '(model 5) ~ Solar-C, SVL, VPD-C, SMI, Hct', 
                       '(model 6) ~ Solar-C, SVL, VPD-C, SMI',
                       '(model 7) ~ Solar-C, SVL, VPD-C', 
                       '(model 8) ~ Solar-C, SVL', 
                       '(model 9) ~ Solar-C', 
                       'null model')
#calculate AIC of each model
osml_AICc <- data.frame(aictab(cand.set = osml_models, 
                                 modnames = osml_mod_names))
osml_AICc
```




### LM Conditions

Check residual plots and VIFs

```{r osml model assumptions}
vif(osml_mod6)
plot(osml_mod6)
simple.eda(residuals(osml_mod6))
shapiro.test(residuals(osml_mod6))
vif(osml_mod7)
plot(osml_mod7)
simple.eda(residuals(osml_mod7))
shapiro.test(residuals(osml_mod7))
```

There is no clear pattern in the residuals ~ fitted plot, so linearity seems satisfied. slight fanning, but equal error variance seems fine. Normality seems fine, even though the Shapiro-Wilk normality test is significant. VIFs essentially negligible.


### Export


First, re-run for p-values:


```{r osmolality best models}
osml_mod6p <- lmerTest::lmer(data = dat,
                          # response variable
                          osmolality_mmol_kg_mean ~ 
                          # body size
                          SVL_mm + SMI +
                          # weather at the time of capture
                          VPD_kPa_int + solar_rad_W_sqm_interpol +
                          (1|capture_date))
summary(osml_mod6p)

osml_mod7p <- lmerTest::lmer(data = dat,
                          # response variable
                          osmolality_mmol_kg_mean ~ 
                          # body size
                          SVL_mm +
                          # weather at the time of capture
                          VPD_kPa_int + solar_rad_W_sqm_interpol +
                          (1|capture_date))
summary(osml_mod7p)
```


Save the model output.

```{r best osml model}
write.csv(broom.mixed::tidy(osml_mod6p),
          "./results_statistics/capture_osml_best_model1.csv")
write.csv(broom.mixed::tidy(osml_mod7p),
          "./results_statistics/capture_osml_best_model2.csv")
write.csv(osml_AICc, "./results_statistics/capture_osml_mod_rankings.csv")
```


To report in paper:

The best models to predict the variation in baseline plasma osmolality included SVL, SMI, VPD, and solar radiation at the time of capture as fixed effects. Date was included as a random effect. The final model had acceptable LM conditions. The full model included mass, SVL, SMI, percent hematocrit, and temperature, VPD, wind speed, and solar radiation at the time of capture, with date as a random effect.



## CEWL

It looks like there are meaningful differences in CEWL across individuals/dates (probably confounded), and based on cloacal temp, capture temp, capture VPD, capture wind, and capture solar radiation.

*I didn't calculate holding time*!!!!!!!!!!!!!!!!!!!

### Models

Start with the full model of all potential predictor variables. We will again include date as a random effect. Individual ID is not included as a random effect bc each lizard only has one set of capture observations.

When we have this many variables, it's extremely important to start with checking for multicollinearity.

```{r CEWL model 1}
CEWL_mod1 <- lme4::lmer(data = dat,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # essential covariate
                          cloacal_temp_C +
                          # body size
                          mass_g + SVL_mm + SMI +
                          # blood
                          osmolality_mmol_kg_mean + hematocrit_percent + 
                          # microclimate at the time of msmt
                          msmt_temp_C + msmt_VPD_kPa +
                          # weather at the time of capture
                          temp_C_interpol * VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol +
                          # time between capture and measurements
                          hold_time_hr + 
                          (1|capture_date))
CEWL_mod1_VIFs <- data.frame(VIF = car::vif(CEWL_mod1)) %>%
  arrange(desc(VIF))
CEWL_mod1_VIFs
drop1(CEWL_mod1)
```


Just as for osmolality, VPD and temperature introduce a lot of collinearity. Start with dropping their interaction:

```{r CEWL model 2}
CEWL_mod2 <- lme4::lmer(data = dat,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # essential covariate
                          cloacal_temp_C +
                          # body size
                          mass_g + SVL_mm + SMI +
                          # blood
                          osmolality_mmol_kg_mean + hematocrit_percent + 
                          # microclimate at the time of msmt
                          msmt_temp_C + msmt_VPD_kPa +
                          # weather at the time of capture
                          temp_C_interpol + VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol +
                          # time between capture and measurements
                          hold_time_hr +
                          (1|capture_date))
CEWL_mod2_VIFs <- data.frame(VIF = car::vif(CEWL_mod2)) %>%
  arrange(desc(VIF))
CEWL_mod2_VIFs
drop1(CEWL_mod2)
```

MUCH better. Drop SVL next:

```{r CEWL model 3}
CEWL_mod3 <- lme4::lmer(data = dat,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # essential covariate
                          cloacal_temp_C +
                          # body size
                          mass_g + SMI +
                          # blood
                          osmolality_mmol_kg_mean + hematocrit_percent + 
                          # microclimate at the time of msmt
                          msmt_temp_C + msmt_VPD_kPa +
                          # weather at the time of capture
                          temp_C_interpol + VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol +
                          # time between capture and measurements
                          hold_time_hr +
                          (1|capture_date))
CEWL_mod3_VIFs <- data.frame(VIF = car::vif(CEWL_mod3)) %>%
  arrange(desc(VIF))
CEWL_mod3_VIFs
drop1(CEWL_mod3)
```


Next drop temperature at the time of capture:

```{r CEWL model 4}
CEWL_mod4 <- lme4::lmer(data = dat,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # essential covariate
                          cloacal_temp_C +
                          # body size
                          mass_g + SMI +
                          # blood
                          osmolality_mmol_kg_mean + hematocrit_percent + 
                          # microclimate at the time of msmt
                          msmt_temp_C + msmt_VPD_kPa +
                          # weather at the time of capture
                          VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol +
                          # time between capture and measurements
                          hold_time_hr +
                          (1|capture_date))
CEWL_mod4_VIFs <- data.frame(VIF = car::vif(CEWL_mod4)) %>%
  arrange(desc(VIF))
CEWL_mod4_VIFs
summary(CEWL_mod4)
drop1(CEWL_mod4)
```


Great, VIFs are minimal and we're ready to start backwards selection!

Start with dropping SMI:

```{r CEWL model 5}
CEWL_mod5 <- lme4::lmer(data = dat,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # essential covariate
                          cloacal_temp_C +
                          # body size
                          mass_g + 
                          # blood
                          osmolality_mmol_kg_mean + hematocrit_percent + 
                          # microclimate at the time of msmt
                          msmt_temp_C + msmt_VPD_kPa +
                          # weather at the time of capture
                          VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol +
                          # time between capture and measurements
                          hold_time_hr +
                          (1|capture_date))
summary(CEWL_mod5)
drop1(CEWL_mod5)
```

next drop cloacal temperature (What?!):

```{r CEWL model 6}
CEWL_mod6 <- lme4::lmer(data = dat,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # body size
                          mass_g + 
                          # blood
                          osmolality_mmol_kg_mean + hematocrit_percent + 
                          # microclimate at the time of msmt
                          msmt_temp_C + msmt_VPD_kPa +
                          # weather at the time of capture
                          VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol +
                          # time between capture and measurements
                          hold_time_hr +
                          (1|capture_date))
summary(CEWL_mod6)
drop1(CEWL_mod6)
```


next drop hematocrit:

```{r CEWL model 7}
CEWL_mod7 <- lme4::lmer(data = dat,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # body size
                          mass_g + 
                          # blood
                          osmolality_mmol_kg_mean +
                          # microclimate at the time of msmt
                          msmt_temp_C + msmt_VPD_kPa +
                          # weather at the time of capture
                          VPD_kPa_int +
                          wind_mph_interpol + solar_rad_W_sqm_interpol +
                          # time between capture and measurements
                          hold_time_hr +
                          (1|capture_date))
summary(CEWL_mod7)
drop1(CEWL_mod7)
```


next drop solar radiation:

```{r CEWL model 8}
CEWL_mod8 <- lme4::lmer(data = dat,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # body size
                          mass_g + 
                          # blood
                          osmolality_mmol_kg_mean +
                          # microclimate at the time of msmt
                          msmt_temp_C + msmt_VPD_kPa +
                          # weather at the time of capture
                          VPD_kPa_int +
                          wind_mph_interpol +
                          # time between capture and measurements
                          hold_time_hr +
                          (1|capture_date))
summary(CEWL_mod8)
drop1(CEWL_mod8)
```


next drop mass:

```{r CEWL model 9}
CEWL_mod9 <- lme4::lmer(data = dat,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # blood
                          osmolality_mmol_kg_mean +
                          # microclimate at the time of msmt
                          msmt_temp_C + msmt_VPD_kPa +
                          # weather at the time of capture
                          VPD_kPa_int +
                          wind_mph_interpol +
                          # time between capture and measurements
                          hold_time_hr +
                          (1|capture_date))
summary(CEWL_mod9)
drop1(CEWL_mod9)
```

next drop VPD:

```{r CEWL model 10}
CEWL_mod10 <- lme4::lmer(data = dat,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # blood
                          osmolality_mmol_kg_mean +
                          # microclimate at the time of msmt
                          msmt_temp_C + msmt_VPD_kPa +
                          # weather at the time of capture
                          wind_mph_interpol +
                          # time between capture and measurements
                          hold_time_hr +
                          (1|capture_date))
summary(CEWL_mod10)
# can't test drop1 bc of NA's 
```

based on t-values, wind should be dropped next:

```{r CEWL model 11}
CEWL_mod11 <- lme4::lmer(data = dat,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # blood
                          osmolality_mmol_kg_mean +
                          # microclimate at the time of msmt
                          msmt_temp_C + msmt_VPD_kPa +
                          # time between capture and measurements
                          hold_time_hr +
                          (1|capture_date))
summary(CEWL_mod11)
```

drop hold time:

```{r CEWL model 11a}
CEWL_mod11a <- lme4::lmer(data = dat,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # blood
                          osmolality_mmol_kg_mean +
                          # microclimate at the time of msmt
                          msmt_temp_C + msmt_VPD_kPa +
                          (1|capture_date))
summary(CEWL_mod11a)
```

drop osmolality:

```{r CEWL model 12}
CEWL_mod12 <- lme4::lmer(data = dat,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # microclimate at the time of msmt
                          msmt_temp_C + msmt_VPD_kPa +
                          (1|capture_date))
summary(CEWL_mod12)
drop1(CEWL_mod12)
```


drop VPD at the time of msmt:

```{r CEWL model 13}
CEWL_mod13 <- lme4::lmer(data = dat,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # microclimate at the time of msmt
                          msmt_temp_C +
                          (1|capture_date))
summary(CEWL_mod13)
```

And finally, null model:

```{r CEWL model null}
CEWL_mod_null <- lme4::lmer(data = dat,
                          # response variable
                          CEWL_g_m2h_mean ~ 1 +
                          (1|capture_date))
summary(CEWL_mod_null)
```



### Selection

compare models 4-13 and the null

```{r CEWL mod compare}
CEWL_models <- list(CEWL_mod4, CEWL_mod5, CEWL_mod6, CEWL_mod7, 
                    CEWL_mod8, CEWL_mod9, CEWL_mod10, CEWL_mod11, CEWL_mod11a,
                    CEWL_mod12, CEWL_mod13, CEWL_mod_null)

#specify model names
CEWL_mod_names <- c('(model 4) ~ Temp-M, VPD-M, Osml, Wind-C, VPD-C, Mass, Solar-C, Hct, Temp-Clo, SMI, Hold', 
                    '(model 5) ~ Temp-M, VPD-M, Osml, Wind-C, VPD-C, Mass, Solar-C, Hct, Temp-Clo, Hold', 
                    '(model 6) ~ Temp-M, VPD-M, Osml, Wind-C, VPD-C, Mass, Solar-C, Hct, Hold', 
                       '(model 7) ~ Temp-M, VPD-M, Osml, Wind-C, VPD-C, Mass, Solar-C, Hold', 
                       '(model 8) ~ Temp-M, VPD-M, Osml, Wind-C, VPD-C, Mass, Hold',
                       '(model 9) ~ Temp-M, VPD-M, Osml, Wind-C, VPD-C, Hold', 
                       '(model 10) ~ Temp-M, VPD-M, Osml, Wind-C, Hold', 
                       '(model 11) ~ Temp-M, VPD-M, Osml, Hold',
                    '(model 11a) ~ Temp-M, VPD-M, Osml',
                      '(model 12) ~ Temp-M, VPD-M',
                      '(model 13) ~ Temp-M',
                      'null model')
#calculate AIC of each model
CEWL_AICc <- data.frame(aictab(cand.set = CEWL_models, 
                                 modnames = CEWL_mod_names))
CEWL_AICc
```


The best two models are 9 & 10, which included Temp-M, VPD-M, Osml, Wind-C, VPD-C (not in 10), and Hold time.



### LM Conditions

Check that the best model meets the criteria for linear regression and has no collinearity.

```{r CEWL model assumptions}
vif(CEWL_mod9)
plot(CEWL_mod9)
simple.eda(residuals(CEWL_mod9))
shapiro.test(residuals(CEWL_mod9))
vif(CEWL_mod10)
plot(CEWL_mod10)
simple.eda(residuals(CEWL_mod10))
shapiro.test(residuals(CEWL_mod10))
```

There is some slight fanning in the residuals ~ fitted plot, suggesting equal error variance is not perfect, but overall, all LNE conditions appear to be met and VIFs are very low.


### Export

First, re-run the best model using lmerTest for p-values.

```{r CEWL best models p vals}
CEWL_mod9p <- lmerTest::lmer(data = dat,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # blood
                          osmolality_mmol_kg_mean +
                          # microclimate at the time of msmt
                          msmt_temp_C + msmt_VPD_kPa +
                          # weather at the time of capture
                          VPD_kPa_int +
                          wind_mph_interpol + hold_time_hr +
                          (1|capture_date))
summary(CEWL_mod9p)

CEWL_mod10p <- lmerTest::lmer(data = dat,
                          # response variable
                          CEWL_g_m2h_mean ~ 
                          # blood
                          osmolality_mmol_kg_mean +
                          # microclimate at the time of msmt
                          msmt_temp_C + msmt_VPD_kPa +
                          # weather at the time of capture
                          wind_mph_interpol + hold_time_hr +
                          (1|capture_date))
summary(CEWL_mod10p)
```

Save the best CEWL model output.

```{r best CEWL model}
write.csv(broom.mixed::tidy(CEWL_mod9p),
          "./results_statistics/capture_CEWL_best_model1.csv")
write.csv(broom.mixed::tidy(CEWL_mod10p),
          "./results_statistics/capture_CEWL_best_model2.csv")
write.csv(CEWL_AICc, 
          "./results_statistics/capture_CEWL_mod_rankings.csv")
```


To report in paper:

The best model to predict CEWL included plasma osmolality, temperature and VPD at the time of measurement, and VPD and wind at the time of capture. The final model met all linear regression conditions for linearity, normality, and equal error variance, and there was no multicollinearity.


# Pub Figures

## Custom Colors

```{r}
lizard_color = "turquoise"
VPD_color = "blue"
temp_color = "gray"
solar_color = "orange"
wind_color = "orange"
date_color = "gray"
osml_color  <- c(brewer.pal(6, "Set2")[c(2)])
```



## Hct ~ SMI

```{r hct SMI fig}
ggplot(dat) + 
  aes(x = SMI,
      y = hematocrit_percent) +
  geom_point(size = 1, 
             alpha = 0.4) + 
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              color = lizard_color,
              alpha = 1) + 
  theme_classic() + 
  xlab("Body Condition (g)") + 
  ylab("Hematocrit (%)") + 
  #ylab("") +
  #xlim() +
  ylim(20,60) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_hct_SMI_fig
cap_hct_SMI_fig
```



## Hct ~ VPD at Capture

```{r hct VPD fig}
ggplot(dat) + 
  aes(x = VPD_kPa_int,
      y = hematocrit_percent) +
  geom_point(size = 1, 
             alpha = 0.4) + 
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = VPD_color,
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("VPD at Capture (kPa)") + 
  ylab("Hematocrit (%)") + 
  #ylab("") +
  #xlim() +
  ylim(20,60) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_hct_VPD_fig
cap_hct_VPD_fig
```



## Hct ~ Wind Speed at Capture

```{r hct wind fig}
ggplot(dat) + 
  aes(x = wind_mph_interpol,
      y = hematocrit_percent)+
  geom_point(size = 1, 
             alpha = 0.4) + 
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = wind_color,
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Wind Speed at Capture (mph)") + 
  ylab("Hematocrit (%)") + 
  #ylab("") +
  #xlim() +
  ylim(20, 60) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_hct_wind_fig
cap_hct_wind_fig
```




## Hct ~ Solar Radiation at Capture

```{r hct sorad fig}
ggplot(dat) + 
  aes(x = solar_rad_W_sqm_interpol,
      y = hematocrit_percent) +
  geom_point(size = 1, 
             alpha = 0.4) + 
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = solar_color,
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab(bquote('Solar Radiation (W/'*m^2*')')) + 
  ylab("Hematocrit (%)") + 
  #ylab("") +
  ylim(20, 60) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_hct_sorad_fig
cap_hct_sorad_fig
```


## Osmolality ~ SVL

```{r osml SVL fig}
ggplot(dat) + 
  aes(x = SVL_mm,
      y = osmolality_mmol_kg_mean) +
  geom_point(size = 1, 
             alpha = 0.4) + 
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              color = lizard_color,
              alpha = 1) + 
  theme_classic() + 
  xlab("Snout-Vent Length (mm)") + 
  ylab("Plasma Osmolality (mmol/kg)") + 
  #ylab("") +
  #xlim() +
  ylim(300,400) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_osml_SVL_fig
cap_osml_SVL_fig
```


## Osmolality ~ SMI

```{r osml SMI fig}
ggplot(dat) + 
  aes(x = SMI,
      y = osmolality_mmol_kg_mean) +
  geom_point(size = 1, 
             alpha = 0.4) + 
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              color = lizard_color,
              alpha = 1) + 
  theme_classic() + 
  xlab("Body Condition (g)") + 
  ylab("Plasma Osmolality (mmol/kg)") + 
  #ylab("") +
  #xlim() +
  ylim(300,400) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_osml_SMI_fig
cap_osml_SMI_fig
```


## Osmolality ~ VPD at Capture

```{r osml VPD fig}
ggplot(dat) + 
  aes(x = VPD_kPa_int,
      y = osmolality_mmol_kg_mean) +
  geom_point(size = 1, 
             alpha = 0.4) + 
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = VPD_color,
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("VPD at Capture (kPa)") + 
  ylab("Plasma Osmolality (mmol/kg)") + 
  #ylab("") +
  #xlim() +
  ylim(300,400) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_osml_VPD_fig
cap_osml_VPD_fig
```


## Osmolality ~ Solar Radiation at Capture

```{r osml sorad fig}
ggplot(dat) + 
  aes(x = solar_rad_W_sqm_interpol,
      y = osmolality_mmol_kg_mean) +
  geom_point(size = 1, 
             alpha = 0.4) + 
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = solar_color,
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab(bquote('Solar Radiation (W/'*m^2*')')) + 
  ylab("Plasma Osmolality (mmol/kg)") + 
  #ylab("") +
  ylim(300,400) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_osml_sorad_fig
cap_osml_sorad_fig
```


## Osmolality ~ Date

```{r osml date fig}
ggplot(dat) + 
  aes(x = as.factor(capture_date),
      y = osmolality_mmol_kg_mean,
      group = as.factor(capture_date)) +
  geom_boxplot() +
  geom_jitter(size = 1, 
              alpha = 0.4) + 
  theme_classic() + 
  xlab("Date") + 
  ylab("Plasma Osmolality (mmol/kg)") + 
  #ylab("") +
  #xlim() +
  ylim(300, 400) +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(R) ^ 2, \" = 0.\")", 
    #       parse = TRUE,
     #      size = 6) +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(p), \" < 0.0001\")", 
    #       parse = TRUE,
     #      size = 6) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_osml_date_fig
cap_osml_date_fig
```









## CEWL ~ Cloacal Temperature

```{r CEWL cloacal temp fig}
ggplot(dat) + 
  aes(x = cloacal_temp_C,
      y = CEWL_g_m2h_mean) +
  geom_point(size = 1, 
             alpha = 0.4) + 
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = temp_color,
              size = 1.6, 
              alpha = 1) + 
  theme_classic() + 
  xlab("Cloacal Temperature (°C)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #ylab("") +
  #xlim() +
  ylim(0, 40) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_CEWL_clotemp_fig
cap_CEWL_clotemp_fig
```


## CEWL ~ Plasma Osmolality

```{r CEWL osml fig}
ggplot(dat) + 
  aes(x = osmolality_mmol_kg_mean,
                 y = CEWL_g_m2h_mean) +
  geom_point(size = 1, 
             alpha = 0.4) + 
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = osml_color,
              size = 1.6, 
              alpha = 1) + 
  theme_classic() + 
  xlab("Plasma Osmolality (mmol/kg)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #ylab("") +
  xlim(300, 400) +
  ylim(0, 40) +
#  manual_color_brewer(, name = "") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_CEWL_osml_fig
cap_CEWL_osml_fig

ggsave(filename = "cap_CEWL_osml_fig.jpeg",
       plot = cap_CEWL_osml_fig,
       path = "./results_figures",
       device = "jpeg",
       dpi = 600,
       width = 6, height = 4)
```



## CEWL ~ Temperature at Measurement

```{r CEWL temp fig}
ggplot(dat) + 
  aes(x = msmt_temp_C,
      y = CEWL_g_m2h_mean) +
  geom_point(size = 1, 
             alpha = 0.4) + 
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = temp_color,
              size = 1.6, 
              alpha = 1) + 
  theme_classic() + 
  xlab("Temperature at Measurement (°C)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #ylab("") +
  #xlim() +
  ylim(0, 40) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_CEWL_temp_fig
cap_CEWL_temp_fig
```


## CEWL ~ VPD at Measurement

```{r CEWL VPD-m fig}
ggplot(dat) + 
  aes(x = msmt_VPD_kPa,
      y = CEWL_g_m2h_mean) +
  geom_point(size = 1, 
             alpha = 0.4) + 
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = VPD_color,
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("VPD at Measurement (kPa)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #ylab("") +
  #xlim() +
  ylim(0, 40) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_CEWL_VPDm_fig
cap_CEWL_VPDm_fig
```




## CEWL ~ VPD at Capture

```{r CEWL VPD-c fig}
ggplot(dat) + 
  aes(x = VPD_kPa_int,
      y = CEWL_g_m2h_mean) +
  geom_point(size = 1, 
             alpha = 0.4) + 
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = VPD_color,
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("VPD at Capture (kPa)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #ylab("") +
  #xlim() +
  ylim(0, 40) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_CEWL_VPDc_fig
cap_CEWL_VPDc_fig
```


## CEWL ~ Wind at Capture

```{r CEWL wind fig}
ggplot(dat) + 
  aes(x = wind_mph_interpol,
      y = CEWL_g_m2h_mean)+
  geom_point(size = 1, 
             alpha = 0.4) + 
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = wind_color,
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Wind Speed at Capture (mph)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #ylab("") +
  #xlim() +
  ylim(0, 40) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_CEWL_wind_fig
cap_CEWL_wind_fig
```


## CEWL ~ Date

```{r CEWL date fig}
ggplot(dat) + 
  aes(x = as.factor(capture_date),
      y = CEWL_g_m2h_mean,
      group = as.factor(capture_date)) +
  geom_boxplot() +
  geom_jitter(size = 1, 
              alpha = 0.4) + 
  theme_classic() + 
  xlab("Date") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #ylab("") +
  #xlim() +
  ylim(0, 40) +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(R) ^ 2, \" = 0.\")", 
    #       parse = TRUE,
     #      size = 6) +
  #annotate("text", x = , y = , 
   #        label = "paste(italic(p), \" < 0.0001\")", 
    #       parse = TRUE,
     #      size = 6) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        #axis.text.y = element_blank(),
        #plot.margin = unit(c(0.1,0,0.1,0.45), "cm")
        ) -> cap_CEWL_date_fig
cap_CEWL_date_fig
```




## Figure Arrangements

```{r FIG ARRANGE}
# hematocrit
ggarrange(cap_hct_sorad_fig, cap_hct_VPD_fig,
          cap_hct_SMI_fig, cap_hct_wind_fig,
          ncol = 2, nrow = 2,
          legend = "none"
          ) -> cap_hct_multi_fig
#cap_hct_multi_fig
# export figure
#ggsave(filename = "cap_hct_multi_fig.jpeg",
 #      plot = cap_hct_multi_fig,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 12, height = 8)


# osmolality
ggarrange(cap_osml_sorad_fig, cap_osml_VPD_fig,
          cap_osml_SMI_fig, cap_osml_SVL_fig,
          ncol = 2, nrow = 2,
          legend = "none"
          ) -> cap_osml_multi_fig
#cap_osml_multi_fig
# export figure
#ggsave(filename = "cap_osml_multi_fig.jpeg",
 #      plot = cap_osml_multi_fig,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 12, height = 8)



# CEWL
ggarrange(cap_CEWL_VPDm_fig, cap_CEWL_VPDc_fig,
          cap_CEWL_temp_fig, cap_CEWL_wind_fig,
          cap_CEWL_osml_fig, cap_CEWL_clotemp_fig,
          ncol = 2, nrow = 3,
          legend = "none"
          ) -> cap_CEWL_multi_fig
#cap_CEWL_multi_fig
# export figure
#ggsave(filename = "cap_CEWL_multi_fig",
 #      plot = cap_CEWL_multi_fig,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 12, height = 16)



# date differences
ggarrange(cap_osml_date_fig, cap_CEWL_date_fig,
          ncol = 1, nrow = 2,
          legend = "none"
          ) -> cap_date_diffs_multi_fig
##cap_date_diffs_multi_fig
# export figure
#ggsave(filename = "cap_date_diffs_multi_fig.jpeg",
 #      plot = cap_date_diffs_multi_fig,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 8)
```















