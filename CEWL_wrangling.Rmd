---
title: "Climate Water Loss Experiment - CEWL Data Wrangling"
author: "Savannah Weaver"
date: "2021"
output: pdf_document
toc: TRUE
---


# Packages


```{r setup, include=FALSE}
`%nin%` = Negate(`%in%`)
if (!require("tidyverse")) install.packages("tidyverse")
library("tidyverse") # workflow and plots
if (!require("UsingR")) install.packages("UsingR")
library("UsingR")
if (!require("lme4")) install.packages("lme4")
library("lme4") # for LMMs
if (!require("lmerTest")) install.packages("lmerTest")
library("lmerTest") # for p-values
```


# Background and Goals

This CEWL (cutaneous evaporative water loss) data was collected June - August using a handheld evaporimeter (BioX AquFlux) on adult male *Sceloporus occidentalis*. Measurements were taken on the dorsum in 5 technical replicates before and after 8 days in different climate treatments. In this R script, I bring all the data files into one dataframe, check the distribution of replicates, omit outliers, and average remaining replicates. The final values will be more precise and accurate estimates of the true CEWL, and those values will be used in the capture_analysis and experiment_analysis R script files. Please refer to **doi:** for the published scientific journal article and full details.


# Load Data

1. Compile a list of the filenames I need to read-in.

```{r}
# make a list of file names of all data to load in
filenames <- list.files(path = "data/CEWL", pattern = "\\.csv$")
```

2. Make a function that will read in the data from each csv, name and organize the data correctly. 

```{r}
read_CEWL_file <- function(filename) {
  
  dat <- read.csv(file.path("data/CEWL", filename), # load file
                header = TRUE # each csv has headers
                ) %>%
    # select only the relevant values
    dplyr::select(date = Date, 
                  time = Time, 
                  status = Status,
                  ID_rep_no = Comments,
                  CEWL_g_m2h = 'TEWL..g..m2h..', 
                  msmt_temp_C = 'AmbT..C.', 
                  msmt_RH_percent = 'AmbRH....'
                  ) %>%
    # extract individual_ID and replicate number
    dplyr::mutate(ID_rep_no = as.character(ID_rep_no),
                  individual_ID = as.numeric(substr(ID_rep_no, 1, 3)),
                  replicate_no = as.numeric(substr(ID_rep_no, 5, 5))
                  )
  
  # return the dataframe for that single csv file
  dat
}
```

3. Apply the function I made to all of the filenames I compiled, then put all of those dataframes into one dataframe. This will print warnings saying that header and col.names are different lengths, because the data has extra notes cols that we read-in, but get rid of.

4. Filter out failed measurements and properly format data classes.

```{r}
# apply function to get data from all csvs
all_CEWL_data <- lapply(filenames, read_CEWL_file) %>%
  # paste all data files together into one df by row
  reduce(rbind) %>%
  # only use completed measurements
  dplyr::filter(status == "Normal") %>%
  # properly format data classes
  mutate(date_time = as.POSIXct(paste(date, time), 
                                format = "%m/%d/%y %I:%M:%S %p"),
         date = as.Date(date, 
                        format = "%m/%d/%y"),
         time = as.POSIXct(time, 
                           format = "%I:%M:%S %p"),
         status = as.factor(status),
         individual_ID = as.factor(individual_ID),
         replicate_no = as.factor(replicate_no)
         )
summary(all_CEWL_data)
```

5. Load in and format the cloacal temperature measured at the time of CEWL measurement.

```{r}
cloacal_temp_C <- read.csv("./data/c_temps.csv", # filename
                             na.strings=c("","NA") # fix empty cells
                             ) %>%
  # select variables of interest
  dplyr::select(date, time_c_temp, 
                day, 
                individual_ID, 
                cloacal_temp_C) %>%
  # properly format data classes
  mutate(date_time = as.POSIXct(paste(date, time_c_temp), 
                                format = "%m/%d/%y %H:%M"),
         date = as.Date(date, format = "%m/%d/%y"),
         time_c_temp = (as.POSIXct(time_c_temp, format = "%H:%M")),
         day = as.factor(day),
         individual_ID = as.factor(individual_ID),
         cloacal_temp_C = as.numeric(cloacal_temp_C)
         ) %>%
  # get rid of rows with missing data
  dplyr::filter(complete.cases(.))
summary(cloacal_temp_C)
```

6. Load in and format the tmt assignments so we know which lizards were removed from the experiment.

```{r}
tmt <- read.csv("./data/tmt_assignments.csv") %>%
  # properly format data classes
  mutate(trial_number = as.factor(trial_number),
         temp_tmt = as.factor(temp_tmt),
         humidity_tmt = as.factor(humidity_tmt),
         individual_ID = as.factor(individual_ID),
         conclusion = as.factor(conclusion)
         )
summary(tmt)

# specifically save a df of canceled ones
canceled <- tmt %>%
  dplyr::filter(conclusion == "canceled") %>%
  dplyr::select(individual_ID)
canceled
```




# Check Data

## Dates

We should only have measurements from day 0 (beginning of date ranges below) and day 8 (end of date ranges below) for each trial.

Trail 1: June 16-24
Trail 2: June 26 - July 4
Trial 3: July 20-28
Trial 4: August 8-16
Trial 5: August 22-30

```{r}
all_CEWL_data %>%
  group_by(date) %>%
  summarise(count = n())
```

All the correct dates, and only the correct dates, are in our dataset. In every trial except trial 5, the number of observations decreases post-experiment compared to pre-experiment, either due to lost lizards or the few that died during the experiment.


## Number of Measurements

Each individual should have 10 total measurements (5 before the experiment, 5 after). 

```{r}
rep_check <- all_CEWL_data %>%
                group_by(individual_ID) %>%
                summarise(n = n()) %>% 
                arrange(n)
rep_check
```

Oof... Many individuals have more or less than 10 CEWL measurements.

too many: 206 & 215 = 11; 237 & 302 = 15
too few: 254 = 3; 213, 216, 245, 278, 289, 294, 305 = 9

There are also a handful with 5 measurements... Check whether these are the ones that had their treatment canceled (thus would only have measurements from pre experiment, not post).

```{r}
# get the individuals with only 5 measures
rep_check5_msmts <- rep_check %>% 
  dplyr::filter(n == 5)
rep_check5_msmts
# when individuals with 5 reps makes sense
rep_check5_msmts %>% 
  dplyr::filter(individual_ID %in% canceled$individual_ID)
```


Of the 7 individuals with only 5 CEWL values, 5 individual lizards (*212*, *233*, *248*, *283*, *284*) had their treatment canceled, so we have an explanation for their missing data.

```{r}
# when individuals with 5 reps DOES NOT make sense
rep_check5_msmts %>% 
  dplyr::filter(individual_ID %nin% canceled$individual_ID)
```

239 and 303 having 5 values is still unexplained and may be due to an error.

```{r}
# individuals with canceled tmt but msmt n != 5
canceled %>% dplyr::filter(individual_ID %nin% rep_check5$individual_ID)
# check their n's
rep_check %>% dplyr::filter(individual_ID %in% c(254, 304))

# check why canceled
tmt %>% dplyr::filter(individual_ID %in% c(254, 304))
```


Individuals 254 and 304 had their treatments canceled, but their n!=5. 254 only had 3 measurements taken because they were lost during CEWL measurement pre-treatment. Individual 304 has the correct number of observations (10), but it was canceled because we realized after the experiment that his toe was already clipped, thus was a recapture from a previous trial and we did not want to include his data. There were no measurement errors for these individuals. Whereas 254's capture measurements can be used for the capture analysis, 304's measurements should be removed from the dataset completely.


Save the individuals with measurement n's that I need to investigate further.

```{r}
indiv_too_few <- rep_check %>% dplyr::filter(n == 9)
indiv_too_many <- rep_check %>% dplyr::filter(n > 10)
other_weird <- rep_check %>% dplyr::filter(individual_ID %in% 
                                             c(239, 303)) # only 5 msmts

# save together to investigate further
weird_n <- indiv_too_few %>%
  rbind(indiv_too_many, other_weird) %>%
  arrange(n)
weird_n
```


Next, check how many measurements each individual has for each date.

```{r}
rep_check_1a <- all_CEWL_data %>%
  dplyr::filter(individual_ID %nin% weird_n$individual_ID) %>%
                group_by(individual_ID, date) %>%
                summarise(n = n()) %>% 
                arrange(n)
rep_check_1a
unique(rep_check_1a$n)
```

It seems I have extracted all of the weird measurements. Every n on a given date ==5 for the individuals not included in my dataframe "weird_n", with the exception of individual 254, which I've already accounted for.

Now I can focus on the observations for the individuals in weird_n.

```{r}
# save ones with one day of 5 msmts so I can filter out others' complete days
two_5s <- all_CEWL_data %>%
  dplyr::filter(individual_ID %in% c(239, 303)) %>%
  group_by(individual_ID, date) %>%
  summarise(n = n())
# get the weird msmt days for others
rep_check_1b <- all_CEWL_data %>%
  dplyr::filter(individual_ID %in% weird_n$individual_ID) %>%
  group_by(individual_ID, date) %>%
  summarise(n = n()) %>% 
  dplyr::filter(n!=5) %>%
  rbind(two_5s) %>%
  arrange(n)
rep_check_1b
```

I have yet to figure out why individuals 213 and 216 (June 24), 245 (July 4), 278 and 289 (July 28), 294 and 305 (August 16) only have 4 observations on that date. The most likely explanation is that we miscounted replicates and only did 4, rather than 5. They have the correct number of measurements on their other measurement days.

Individuals 206 and 215 both have one extra replicate on June 24. Individuals 237 and 302 both have **10** replicates! On July 4 and August 8, respectively. They have the correct number of measurements on their other measurement days.

239 and 303 only have one day of measurements.

I will need to do more digging to figure out why these individuals have the wrong number of measurements on these dates.



## Extra/Missing Measurements

Get all the data for the ones that aren't right:

```{r}
rep_check_2 <- all_CEWL_data %>%
                dplyr::filter(individual_ID %in% rep_check_1b$individual_ID &
                                date %in% rep_check_1b$date) %>%
  group_by(individual_ID, date) %>%
  mutate(n = nrow(CEWL_g_m2h))
```

Look at the weird data one at a time, starting with sets with too many replicates.

```{r}
rep_check_2 %>%
  dplyr::filter(individual_ID == 302)
tmt %>%
  dplyr::filter(individual_ID == 302)
```

Individual 302 has two sets of replicates from his capture day. One set is probably from him and the other set belongs to the lizard measured before or after him. Thankfully, on capture day, lizards are measured in number order, so I know it's probably either Individual 301 or 303. Since 303 is missing measurements, we'll check that.

```{r}
all_CEWL_data %>%
  dplyr::filter(individual_ID == 303)
tmt %>%
  dplyr::filter(individual_ID == 303)
```

As suspected, Individual 303 only has pre-experiment measurements. We can check the time cloacal temperature was measured for these lizards on capture day to see which set of CEWL measurements belongs to who.

```{r}
cloacal_temp_C %>% 
  dplyr::filter(individual_ID %in% c(302,303) & 
                  date == as.Date("2021-08-08"))
```

302's temperature was taken at 13:06 and 303's temperature was taken at 13:13, so **the 13:01-13:05 CEWL measurements are for 302 and the 13:09-13:12 CEWL measurements are for 303**.

### I will need to reassign the measurements attributed to individual 302 taken between 13:09-13:12 on August 8 as pre-experiment measurements for individual 303. 

Discrepancies in number of measurements for individuals 302 and 303 solved!

```{r}
rep_check_3 <- rep_check_2 %>%
  dplyr::filter(individual_ID %nin% c(302, 303)) %>%
  arrange(individual_ID)
# remaining individuals with replicate n's to investigate
unique(rep_check_3$individual_ID)
```


Next:

```{r}
rep_check_2 %>%
  dplyr::filter(individual_ID == 237)
tmt %>%
  dplyr::filter(individual_ID == 237)
```

Individual 237 also has an extra set of replicate measurements on the post-experiment day. The two sets of measurements are taken at two very different time blocks: 10:26-10:32 vs 12:21-12:24.

Interestingly, a closeby number is missing some measurements:

```{r}
rep_check_2 %>%
  dplyr::filter(individual_ID == 239)
tmt %>%
  dplyr::filter(individual_ID == 239)
```

Individual 239 is missing his post-experiment measurements on July 4. So, use cloacal temperature measurement times again to fix:

```{r}
cloacal_temp_C %>% 
  dplyr::filter(individual_ID %in% c(237,239) & 
                  date == as.Date("2021-07-04"))
```

237's temperature was taken at 12:24 and 239's temperature was taken at 10:33, so **the 12:21-12:24 CEWL measurements are for 237 and the 10:26-10:32 CEWL measurements are for 239**.

### I will need to reassign the measurements attributed to individual 237 taken between 10:26-10:32 on July 4 as post-experiment measurements for individual 239. Discrepancies in number of measurements for individuals 237 and 239 solved!

Next:

```{r}
rep_check_2 %>%
  dplyr::filter(individual_ID == 215)
```

The measurement from June 24 at 11:53:32 has a completely different time and CEWL value than the other measurements for Individual 215 on that day. I can check cloacal temperature times from that day to make sure it's not a measurement for 215 and check whether it might belong to someone else.

```{r}
cloacal_temp_C %>% 
  dplyr::filter(date == as.Date("2021-06-24")) %>%
  arrange(time_c_temp)
```

215 had his cloacal temperature taken at 11:16, confirming that only the CEWL values from between 11:12-11:16 are his. Individual 213 had his cloacal temp taken at 11:53, and 226 had his taken at 11:58. Now I can check whether either of them are missing CEWL values and what time their CEWL measurements were taken.

```{r}
rep_check_2 %>%
  dplyr::filter(individual_ID == 213)
all_CEWL_data %>%
  dplyr::filter(individual_ID == 226)
```

Individual 226 isn't missing anything. BUT, individual 213 is missing his fifth replicate of CEWL measurements taken post-experiment. The 4 measurements currently attributed to him were taken between 11:49-11:52, so the extra value attributed to 215 at 11:53 fits perfectly into that sequence of replicates.

### I will need to reassign the measurement attributed to individual 215 at 11:53 on June 24 as the fifth post-experiment measurement for individual 213. Discrepancies in number of measurements for individuals 215 and 213 solved!


Next:

```{r}
rep_check_2 %>%
  dplyr::filter(individual_ID == 206)
```

***left off assessing 206's extra value***







```{r}
rep_check_2 %>%
  dplyr::filter(individual_ID == 216)
```
```{r}
rep_check_2 %>%
  dplyr::filter(individual_ID == 245)
```
```{r}
rep_check_2 %>%
  dplyr::filter(individual_ID == 278)
```
```{r}
rep_check_2 %>%
  dplyr::filter(individual_ID == 289)
```
```{r}
rep_check_2 %>%
  dplyr::filter(individual_ID == 294)
```
```{r}
rep_check_2 %>%
  dplyr::filter(individual_ID == 305)
```



## Check List

Ensure I investigated each of the individuals that I noted had the wrong number of CEWL measurements

```{r}
wrong_amts %>%
  dplyr::filter(individual_ID %nin% c(302,303,237,239,213,215))
```


## Missing Measurements

Which individuals are missing replicates?

```{r}
individuals_missing_reps <- rep_check_1 %>%
  dplyr::filter(n < 5)
individuals_missing_reps
```

Maybe 215 stole one of the 216 measurements?

Specifically check how many replicates individuals on either side of the jumbo-replicates had.

```{r}
IDs_to_check <- c(205, 207, 214, 216, 232, 234, 236, 238, 301, 303)
at_risk_missing_reps <- rep_check_1 %>%
  dplyr::filter(individual_ID %in% IDs_to_check) %>%
  arrange(individual_ID)
at_risk_missing_reps
```

Individual 216 is missing a measurement on June 24 and individual 303 is missing all their measurements on August 8.

Individuals 205, 207, 214, 232, 234, 236, 238, and 301 have all expected measurements.

Also check whether any other individuals are missing all measurements for a given date:

```{r}
rep_check_1 %>% # should have 2 occurrences per individual ID
  group_by(individual_ID) %>%
  summarise(n = n()) %>%
  dplyr::filter(n == 1)
```

8 Individuals are missing data for one date. 
Individuals 212, 233, 248, 254, 283, and 284 died during or were removed from the experiment, so it would make sense to only have one date of CEWL measurements (capture day, pre-experiment). I will leave these in the dataset because I can still use them for 'capture_analysis'.

Individuals 239 and 303 should have measurements for 2 dates, so there's potential that their measurements were "stolen".


## Associations

View the measurements in question:

```{r}
rep_check_3 <- all_CEWL_data %>%
  dplyr::filter(individual_ID %in% c(216, 239, 303 # adjacent missing ones
                                     #215, 302 # adjacent extra ones
                                     #206, 233, 237 # other extra ones
                                     ) 
                ) %>%
  arrange(individual_ID, date, time)
rep_check_3
```

*The duplicates for Individual 206 seem fine. I'll rename one "6".*

The extra value for Individual 233 is a completely different time, so I'm going to omit that value. 

Individual 237 has two rounds of measurements on July 4, I'll need to figure out which group of values to use because they're so different.

The extra value for Individual 215 on June 24 was taken ~40 minutes later than the rest of the measurements, at 11:53:32 AM, so definitely possible that the individual ID was a typo.

The two groups of values taken for Individual 302 on August 8 are clearly in two groupings, so one group is probably for a different Individual.

*Individual 216 I think only had 4 measurements. Emily must have skipped "4".* The time doesn't match up with the extra value for Individual 215, so *the extra value for Individual 215 should be omitted*.

*Individual 239 is missing their post-experiment measurements from July 4, which is probably one of the groups labeled as Individual 237.* 

*Individual 303 is missing their pre-experiment measurements from August 8, which is probably one of the groups labeled as Individual 302.*

To figure out which groups of CEWL measurements were assigned incorrectly, I can use the time noted at cloacal temperature measurement:

```{r}
cloacal_temp_C %>%
  dplyr::filter(individual_ID %in% c(239, 237, 303, 302))
all_CEWL_data %>%
  dplyr::filter(individual_ID %in% c(239, 237, 303, 302))
```

Cloacal temperature measurement times:
I239, July 4: 10:33
I237, July 4: 12:24
I303, Aug 8: 12:49 PM
I302, Aug 8: 12:55 PM

So, assigned groups of times of CEWL measurements:
I239, July 4: 10:26 - 10:33
I237, July 4: 12:21 - 12:25

The times don't match up for these ones weirdly, but based on interrelation:
I303, Aug 8: 1:01 - 1:06 PM
I302, Aug 8: 1:09 - 1:13 PM


## Properly Re-Assigning Measurements

304's measurements should be removed from the dataset completely.

Measurements for individuals currently labeled 206, 215, 237, and 302 need to have editing done.

1. Reassign one of the 206 replicates as "replicate 6":

```{r}
all_CEWL_data[228, "replicate_no"] <- 6
```

2. Reassign some 237 values to 239:

```{r}
all_CEWL_data[801:805, "individual_ID"]
all_CEWL_data[801:805, "individual_ID"] <- 239
all_CEWL_data[801:805, "individual_ID"]
```

3. Reassign some 302 values to 303:

```{r}
all_CEWL_data[1074:1078, "individual_ID"]
all_CEWL_data[1074:1078, "individual_ID"] <- 303
all_CEWL_data[1074:1078, "individual_ID"]
```

4. In looking at the dataframe, I realized the weird 215 value is actually a mis-labeled value for individual 213, so reassign that:

```{r}
all_CEWL_data[241, "individual_ID"] <- 213
all_CEWL_data[241, "replicate_no"] <- 5
```



# Format Data

```{r}
clean_CEWL <- all_CEWL_data %>%
  mutate(date = as.Date(date, format = "%m/%d/%y"),
         time = as.POSIXct(time, format = "%H:%M"),
         status = as.factor(status),
         individual_ID = as.factor(individual_ID),
         replicate_no = as.factor(replicate_no)
  )
summary(clean_CEWL)
```


# Re-Check Data

## Number of Measurements

Re-check how many measurements each individual has:

```{r}

```


## Measurement Times

Also check that all the measurement times for a given individual on a certain date are within ~10 minutes:

```{r}

```






# Replicates

## Check Distribution
## Technical Replicates COV

```{r}
COVs <- all_CEWL_data %>%
  group_by(individual_ID, date) %>%
  summarise(CEWL_mean = mean(CEWL_g_m2h),
            CEWL_SD = sd(CEWL_g_m2h),
            COV = (CEWL_SD/CEWL_mean) *100
            )
summary(COVs)
sd(COVs$CEWL_mean)
sd(COVs$COV)
```


## Remove Outliers

## Re-Check Distribution


## Average Replicates (outliers now removed) & Join Cloacal Temp Data

```{r}
CEWL_final <- CEWL_clean %>%
  group_by(date, individual_ID) %>%
  summarise(CEWL_g_m2h = mean(CEWL_g_m2h)) %>%
  left_join(cloacal_temp_C, by = c('date', 'individual_ID'))
```


# Export

```{r}
write.csv(CEWL_final, "./data/CEWL_dat_all_clean.csv")
```



*other stuff*
after finishing CEWL, go straight to avg osml
do very simple invert analysis of just water content over time
















