---
title: "Climate Water Loss Experiment - Weather Over Time"
author: "Savannah Weaver"
date: "2021"
output: pdf_document
toc: TRUE
---

# Packages

```{r setup, include = TRUE, message = FALSE}
if (!require("tidyverse")) install.packages("tidyverse")
library("tidyverse") # workflow and plots
if (!require("weathermetrics")) install.packages("weathermetrics")
library("weathermetrics") # F to C conversion
if (!require("RColorBrewer")) install.packages("RColorBrewer")
library("RColorBrewer") # color
if (!require("ggpubr")) install.packages("ggpubr")
library("ggpubr") # for multi-ggplot figs
```

# Background

Our analyses of baseline variation in CEWL and plasma osmolality yielded VERY different models for this current project/dataset compared to our last iteration of data collection. In this Rmd, I investigate the weather trends across both studies to assess whether variation, or lack of, in weather may have affected the very different results we got.


# Load Data

```{r load and format data}
weather_dat_XL <- read.csv("./data/weather_long_term.csv", sep = ';') %>%
  mutate(temperature_F = as.numeric(temperature_F),
         wind_speed_mph = as.numeric(wind_speed_mph),
         RH_percent = as.numeric(RH_percent),
         solar_radiation_W_m2 = as.numeric(solar_radiation_W_m2),
         date_time = as.POSIXct(paste(date, time), 
                                format = "%m/%d/%y %I:%M %p"),
         date = as.Date(date, format = "%m/%d/%y"),
         temp_C = fahrenheit.to.celsius(temperature_F, round = 2),
         temp_K = temp_C + 273.15,
         e_s_kPa = 0.611*exp((2500000/461.5)*
                                  ((1/273)-(1/temp_K))),
         e_a_kPa = e_s_kPa * (RH_percent/100),
         VPD_kPa = e_s_kPa - e_a_kPa,
         e_s_kPa_CN98 = 0.611 * exp((17.502*temp_C)/(temp_C + 240.97)),
         # VPD, Campbell & Normal 1998
         VPD_kPa_CN98 = e_s_kPa_CN98*(1 - (RH_percent/100))
         ) %>%
  dplyr::filter(complete.cases(temp_C, VPD_kPa_CN98)) 
weather_dat <- weather_dat_XL %>%
  dplyr::filter(date_time >= "2021-04-01 00:00:00" & 
                  date_time <= "2021-09-01 00:00:00")
weather_dat_active_szn <- weather_dat_XL %>%
  dplyr::filter(date_time >= "2021-03-01 00:00:00" & 
                  date_time <= "2021-10-01 00:00:00")
 summary(weather_dat)
```


get average daily values:

```{r}
weather_dat_daily <- weather_dat %>%
  group_by(date) %>%
  summarise(temp_C = mean(temp_C),
            VPD_kPa = mean(VPD_kPa_CN98),
            RH_percent = mean(RH_percent),
            wind_speed_mph = mean(wind_speed_mph),
            solar_radiation_W_m2 = mean(solar_radiation_W_m2)
            )
```



# Visualize

## Temperature

```{r temp over time}
ggplot(data = weather_dat, 
       aes(x = date_time,
                y = temp_C)) + 
  # all data
  geom_line(alpha = 0.6,
            color = "gray") +
  # trend over time
  stat_smooth(formula = y ~ x, 
              method = "loess", 
              color = "black",
              se = F, 
              size = 2,
              alpha = 1 ) + 
  # sampling dates for BOTH studies
  geom_vline(xintercept = as.POSIXct("2021-04-05 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-04-19 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-04-26 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-05-03 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-05-10 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-05-17 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-06-16 00:00:00"), size = 1,
             color = "lightskyblue3") +
  geom_vline(xintercept = as.POSIXct("2021-06-26 00:00:00"), size = 1,
             color = "lightskyblue3") +
  geom_vline(xintercept = as.POSIXct("2021-07-20 00:00:00"), size = 1,
             color = "lightskyblue3") +
  geom_vline(xintercept = as.POSIXct("2021-08-08 00:00:00"), size = 1,
             color = "lightskyblue3") +
  geom_vline(xintercept = as.POSIXct("2021-08-22 00:00:00"), size = 1,
             color = "lightskyblue3") +
  # rest is formatting
  theme_classic() + 
  xlab("") + 
  ylab("Temperature (°C)") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "right"
        ) -> temp_fig
temp_fig
```


## VPD

```{r VPD over time}
ggplot(data = weather_dat, 
       aes(x = date_time,
                y = VPD_kPa_CN98)) + 
  # all data
  geom_line(alpha = 0.6,
            color = "gray") +
  # trend over time
  stat_smooth(formula = y ~ x, 
              method = "loess", 
              color = "black",
              se = F, 
              size = 2,
              alpha = 1 ) + 
  # sampling dates for BOTH studies
  geom_vline(xintercept = as.POSIXct("2021-04-05 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-04-19 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-04-26 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-05-03 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-05-10 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-05-17 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-06-16 00:00:00"), size = 1,
             color = "lightskyblue3") +
  geom_vline(xintercept = as.POSIXct("2021-06-26 00:00:00"), size = 1,
             color = "lightskyblue3") +
  geom_vline(xintercept = as.POSIXct("2021-07-20 00:00:00"), size = 1,
             color = "lightskyblue3") +
  geom_vline(xintercept = as.POSIXct("2021-08-08 00:00:00"), size = 1,
             color = "lightskyblue3") +
  geom_vline(xintercept = as.POSIXct("2021-08-22 00:00:00"), size = 1,
             color = "lightskyblue3") +
  # rest is formatting
  theme_classic() + 
  xlab("") + 
  ylab("VPD (kPa)") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "right"
        ) -> VPD_fig
VPD_fig
```



## Wind Speed

```{r wind over time}
ggplot(data = weather_dat, 
       aes(x = date_time,
                y = wind_speed_mph)) + 
  # all data
  geom_line(alpha = 0.6,
            color = "gray") +
  # trend over time
  stat_smooth(formula = y ~ x, 
              method = "loess", 
              color = "black",
              se = F, 
              size = 2,
              alpha = 1 ) + 
  # sampling dates for BOTH studies
  geom_vline(xintercept = as.POSIXct("2021-04-05 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-04-19 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-04-26 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-05-03 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-05-10 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-05-17 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-06-16 00:00:00"), size = 1,
             color = "lightskyblue3") +
  geom_vline(xintercept = as.POSIXct("2021-06-26 00:00:00"), size = 1,
             color = "lightskyblue3") +
  geom_vline(xintercept = as.POSIXct("2021-07-20 00:00:00"), size = 1,
             color = "lightskyblue3") +
  geom_vline(xintercept = as.POSIXct("2021-08-08 00:00:00"), size = 1,
             color = "lightskyblue3") +
  geom_vline(xintercept = as.POSIXct("2021-08-22 00:00:00"), size = 1,
             color = "lightskyblue3") +
  # rest is formatting
  theme_classic() + 
  xlab("") + 
  ylab("Wind Speed (mph)") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "right"
        ) -> wind_fig
wind_fig
```




## Solar Radiation

```{r sorad over time}
ggplot(data = weather_dat, 
       aes(x = date_time,
                y = solar_radiation_W_m2)) + 
  # all data
  geom_line(alpha = 0.6,
            color = "gray") +
  # trend over time
  stat_smooth(formula = y ~ x, 
              method = "loess", 
              color = "black",
              se = F, 
              size = 2,
              alpha = 1 ) + 
  # sampling dates for BOTH studies
  geom_vline(xintercept = as.POSIXct("2021-04-05 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-04-19 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-04-26 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-05-03 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-05-10 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-05-17 00:00:00"), size = 1,
             color = "lightpink3") +
  geom_vline(xintercept = as.POSIXct("2021-06-16 00:00:00"), size = 1,
             color = "lightskyblue3") +
  geom_vline(xintercept = as.POSIXct("2021-06-26 00:00:00"), size = 1,
             color = "lightskyblue3") +
  geom_vline(xintercept = as.POSIXct("2021-07-20 00:00:00"), size = 1,
             color = "lightskyblue3") +
  geom_vline(xintercept = as.POSIXct("2021-08-08 00:00:00"), size = 1,
             color = "lightskyblue3") +
  geom_vline(xintercept = as.POSIXct("2021-08-22 00:00:00"), size = 1,
             color = "lightskyblue3") +
  # rest is formatting
  theme_classic() + 
  xlab("") + 
  ylab(bquote('Solar Radiation (W/'*m^2*')')) + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 22),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 16),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "right"
        ) -> sorad_fig
sorad_fig
```




## Active Season 

```{r}
# mean tmt values
tmts <- data.frame(tmt = c("Cool Humid", "Hot Humid", "Cool Dry", "Hot Dry"),
                   VPD_kPa = c(0.6, 1.1, 2.5, 3.8),
                   temp_C = c(23.8, 34.9, 24.4, 35.5),
                   RH_percent = c(78.3, 80.9, 17.9, 34.1))
tmts$tmt <- factor(tmts$tmt,
                   levels = c("Cool Humid", "Hot Humid", "Cool Dry", "Hot Dry"))
# colors, shapes, labels
CH_color <- brewer.pal(4, "Spectral")[c(4)]
HH_color <- brewer.pal(4, "Spectral")[c(2)]
CD_color <- brewer.pal(4, "Spectral")[c(3)]
HD_color <- brewer.pal(4, "Spectral")[c(1)]
my_colors <- c(CH_color, HH_color, CD_color, HD_color)
CH_shp <- 15
HH_shp <- 19
CD_shp <- 15
HD_shp <- 19
my_shapes <- c(CH_shp, HH_shp, CD_shp, HD_shp)
my_labels <- c("Cool Humid\n0.6 kPa",
                               "Hot Humid\n1.1 kPa",
                               "Cool Dry\n2.5 kPa",
                               "Hot Dry\n3.8 kPa")

# plot
ggplot() +
  geom_tile(data = weather_dat_active_szn,
            aes(x = temp_C, 
                y = RH_percent,
                fill = VPD_kPa_CN98),
            alpha = 0.5,
            height = 1,
            width = 0.4) +
  geom_point(data = tmts,
             aes(x = temp_C,
                 y = RH_percent, 
                 color = tmt,
                 shape = tmt), 
              size = 4,
              alpha = 1) +
  scale_fill_distiller(palette = "PuRd", direction = 1, name = NULL) +
  theme_classic() + 
  scale_shape_manual(values = my_shapes, name = NULL,
                     labels = my_labels) +
  scale_color_manual(values = my_colors, name = NULL,
                     labels = my_labels) +
  xlab("Temperature (°C)") + 
  ylab("Relative Humidity (%)") + 
  guides(shape = guide_legend(nrow = 4, byrow = TRUE),
         #fill = guide_legend(title.position = "left") # makes color ramp weird
         ) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 8),
        #axis.text.x = element_blank(),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 8),
        legend.text.align = 0,
        legend.position = "bottom",
        legend.title.align = 0.5,
        legend.direction = "vertical",
        legend.margin = unit(10, "mm")
        #plot.margin = unit(c(0, #top
         #                     0, #right
          #                    0, #bottom
           #                   0), "mm")
        ) -> tmt_weather_fig
tmt_weather_fig

# use ggarrange so legend is centered
tmt_weather_fig_formatted <- ggarrange(tmt_weather_fig,
                                        ncol = 1, nrow = 1,
                                        common.legend = TRUE,
                                        legend = "bottom")
# save
ggsave(filename = "exp_vs_weather_fig.pdf",
       plot = tmt_weather_fig,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 80, height = 100)
```






# Stats


## Variability

```{r var stats}
variation <- weather_dat %>%
  mutate(study = as.factor(case_when(date_time >= "2021-04-05 00:00:00" & 
                                       date_time <= "2021-05-18 00:00:00" ~
                                       "spring",
                                     date_time >= "2021-06-16 00:00:00" &
                                       date_time <= "2021-08-23 00:00:00" ~
                                       "summer"
                                       ))) %>%
  dplyr::filter(complete.cases(study)) %>%
  group_by(study) %>%
  summarise(temp_CV = (sd(temp_C)/mean(temp_C)) *100,
            temp_range = max(temp_C) - min(temp_C),
            VPD_CV = (sd(VPD_kPa_CN98)/mean(VPD_kPa_CN98)) *100,
            VPD_range = max(VPD_kPa_CN98) - min(VPD_kPa_CN98),
            wind_CV = (sd(wind_speed_mph)/mean(wind_speed_mph)) *100,
            wind_range = max(wind_speed_mph) - min(wind_speed_mph),
            sorad_CV = (sd(solar_radiation_W_m2)/mean(solar_radiation_W_m2)) *100,
            sorad_range = max(solar_radiation_W_m2) - min(solar_radiation_W_m2)
            )
variation
```


Weather variability (CV):
temp: spring >>> summer
VPD: spring > summer
wind: spring < summer
sorad: spring >>> summer

Range differences are pretty negligible.


## SLR ~ Date

Try a simple linear model of weather ~ date:

```{r}
summary(lm(data = weather_dat_daily, temp_C ~ date))
summary(lm(data = weather_dat_daily, VPD_kPa ~ date))
summary(lm(data = weather_dat_daily, wind_speed_mph ~ date))
summary(lm(data = weather_dat_daily, solar_radiation_W_m2 ~ date))
```



Of the 4 weather variables, mean daily values correlated with date for only temperature (estimate = 0.05, SE = 0.004, df = 152, p < 0.0001) and wind speed (estimate = -0.005, SE = 0.002, df = 152, p = 0.007).






## Daily Humidity

```{r}
mean_humid_VPD <- weather_dat %>%
  # filter to be only for study 2
  dplyr::filter(date > "2021-06-15") %>%
  # get daytime values only, 6 am to 8 pm
  dplyr::filter(as.numeric(substr(date_time, 12, 13)) < 20 &
                  as.numeric(substr(date_time, 12, 13)) > 6) %>%
  # get by date first
  group_by(date) %>%
  summarise(VPD_kPa_CN98 = mean(VPD_kPa_CN98),
            RH_percent = mean(RH_percent)) %>%
  # mean across dates
  summarise(mean_VPD = mean(VPD_kPa_CN98),
            sd_VPD = sd(VPD_kPa_CN98),
            mean_RH = mean(RH_percent),
            sd_RH = sd(RH_percent))
mean_humid_VPD
```


Mean daily relative humidity during the CWL 2021 study was 73±9%!
















